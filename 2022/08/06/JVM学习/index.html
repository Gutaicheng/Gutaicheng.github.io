

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/tubiao2.png">
  <link rel="icon" href="/img/tubiao2.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="GuTaicheng">
  <meta name="keywords" content="博客, 学习, Java">
  
    <meta name="description" content="引言本博客是根据黑马程序员JVM完整教程教学视频学习时，所做的笔记  ps: 实际字数没那么多，上面显示的是字符数   1.内存结构1.1 程序计数器Program Counter Register 程序计数器（寄存器） 1.1.1 作用是记住下一条jvm指令的执行地址 (例如解释器取出3后，4就会存入程序计数器)   1.1.2 特点是线程私有的（每个线程都有自己私有的程序计数器）； 不会存">
<meta property="og:type" content="article">
<meta property="og:title" content="jvm学习">
<meta property="og:url" content="https://blog.gutaicheng.top/2022/08/06/JVM%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="GuTaicheng&#39;s Blog">
<meta property="og:description" content="引言本博客是根据黑马程序员JVM完整教程教学视频学习时，所做的笔记  ps: 实际字数没那么多，上面显示的是字符数   1.内存结构1.1 程序计数器Program Counter Register 程序计数器（寄存器） 1.1.1 作用是记住下一条jvm指令的执行地址 (例如解释器取出3后，4就会存入程序计数器)   1.1.2 特点是线程私有的（每个线程都有自己私有的程序计数器）； 不会存">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/Gu-taicheng/image/raw/master/img/20220807002119.png">
<meta property="article:published_time" content="2022-08-05T18:10:52.000Z">
<meta property="article:modified_time" content="2022-10-06T08:56:43.147Z">
<meta property="article:author" content="GuTaicheng">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="JVM">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gitee.com/Gu-taicheng/image/raw/master/img/20220807002119.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>jvm学习 - GuTaicheng&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.gutaicheng.top","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":21404155,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    <!-- 51.la Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('//js.users.51.la/21404155.js');
      }
    </script>
  

  

  



  
  <meta name="referrer" content="never">
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>GuTaicheng</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/article-bg1.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="jvm学习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-06 02:10" pubdate>
          2022年8月6日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          46k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          383 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">jvm学习</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer" />

<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>本博客是根据<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP"><strong>黑马程序员JVM完整教程</strong></a>教学视频学习时，所做的笔记</p>
<blockquote>
<p>ps: 实际字数没那么多，上面显示的是字符数</p>
</blockquote>
<hr>
<h1 id="1-内存结构"><a href="#1-内存结构" class="headerlink" title="1.内存结构"></a>1.内存结构</h1><h2 id="1-1-程序计数器"><a href="#1-1-程序计数器" class="headerlink" title="1.1 程序计数器"></a>1.1 程序计数器</h2><p>Program Counter Register 程序计数器（寄存器）</p>
<h3 id="1-1-1-作用"><a href="#1-1-1-作用" class="headerlink" title="1.1.1 作用"></a>1.1.1 作用</h3><p>是记住下一条jvm指令的执行地址</p>
<p>(例如解释器取出3后，4就会存入程序计数器)</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806164540695.png" srcset="/img/loading.gif" lazyload alt="image-20220806164540695"></p>
<hr>
<h3 id="1-1-2-特点"><a href="#1-1-2-特点" class="headerlink" title="1.1.2 特点"></a>1.1.2 特点</h3><p>是线程<strong>私有</strong>的（每个线程都有自己私有的程序计数器）；</p>
<p>不会存在内存溢出</p>
<hr>
<h2 id="1-2-虚拟机栈"><a href="#1-2-虚拟机栈" class="headerlink" title="1.2 虚拟机栈"></a>1.2 虚拟机栈</h2><h3 id="1-2-1-定义"><a href="#1-2-1-定义" class="headerlink" title="1.2.1 定义"></a>1.2.1 定义</h3><p>Java Virtual Machine Stacks （Java 虚拟机栈）</p>
<p>每个线程运行时所需要的内存，称为虚拟机栈</p>
<p>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存</p>
<p>每个线程只能有<strong>一个</strong>活动栈帧，对应着当前正在执行的那个方法</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806165228402.png" srcset="/img/loading.gif" lazyload alt="image-20220806165228402"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806165238256.png" srcset="/img/loading.gif" lazyload alt="image-20220806165238256"></p>
<p>问题辨析</p>
<ol>
<li>垃圾回收是否涉及栈内存？</li>
</ol>
<p>答：不涉及、垃圾回收是回收的堆内存的无用对象</p>
<ol start="2">
<li>栈内存分配越大越好吗？</li>
</ol>
<p>答：不是，会使线程变少</p>
<ol start="3">
<li>方法内的局部变量是否线程安全？</li>
</ol>
<p>答：如果方法内局部变量没有逃离方法的作用访问，它是线程安全的</p>
<p>如果是局部变量引用了对象，并逃离方法的作用范围，需要考虑线程安全</p>
<hr>
<h3 id="1-2-2-栈内存溢出"><a href="#1-2-2-栈内存溢出" class="headerlink" title="1.2.2 栈内存溢出"></a>1.2.2 栈内存溢出</h3><ul>
<li>栈帧过多导致栈内存溢出（比如典型的递归、当没有设置正确的递归边界 ）</li>
<li>栈帧过大导致栈内存溢出（很少出现）</li>
</ul>
<hr>
<h2 id="1-3-本地方法栈"><a href="#1-3-本地方法栈" class="headerlink" title="1.3 本地方法栈"></a>1.3 本地方法栈</h2><p>就是有些代码底层是由C&#x2F;C++实现的就是操作系统的方法，Java只需要用native标记一下即可、比如Object下的clone()、HashCode()；</p>
<h2 id="1-4-堆"><a href="#1-4-堆" class="headerlink" title="1.4 堆"></a>1.4 堆</h2><h3 id="1-4-1-定义"><a href="#1-4-1-定义" class="headerlink" title="1.4.1 定义"></a>1.4.1 定义</h3><p>Heap 堆</p>
<p>通过 new 关键字，创建对象都会使用堆内存</p>
<p>特点:</p>
<p>它是线程共享的，堆中对象都需要考虑线程安全的问题</p>
<p><strong>有垃圾回收机制</strong></p>
<hr>
<h3 id="1-4-2-堆内存溢出"><a href="#1-4-2-堆内存溢出" class="headerlink" title="1.4.2 堆内存溢出"></a>1.4.2 堆内存溢出</h3><p>不断的产生对象、且有人使用它、渐渐的就会产生堆内存溢出</p>
<p>java.lang.OutofMemoryError ：java heap space. 堆内存溢出</p>
<p>可以使用 -Xmx8m 来指定堆内存大小。</p>
<hr>
<h2 id="1-5-方法区"><a href="#1-5-方法区" class="headerlink" title="1.5 方法区"></a>1.5 方法区</h2><h3 id="1-5-1-定义"><a href="#1-5-1-定义" class="headerlink" title="1.5.1 定义"></a>1.5.1 定义</h3><p>Method Area</p>
<p>The Java Virtual Machine has a <em>method area</em> that is shared among all Java Virtual Machine threads. The method area is analogous to the storage area for compiled code of a conventional language or analogous to the “text” segment in an operating system process. It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9">§2.9</a>) used in class and instance initialization and interface initialization.</p>
<p>Java虚拟机具有一个方法区域，该方法区域在所有Java虚拟机线程中共享。该方法区域类似于存储区域的常规语言代码或类似于操作系统过程中的“文本”段。它存储了每个类结构，例如运行时常数池，字段和方法数据以及方法和构造函数的代码，包括类和实例初始化和接口初始化中使用的特殊方法（§2.9）。</p>
<p>The method area is created on virtual machine start-up. Although the method area is logically part of the heap, simple implementations may choose not to either garbage collect or compact it. This specification does not mandate the location of the method area or the policies used to manage compiled code. The method area may be of a fixed size or may be expanded as required by the computation and may be contracted if a larger method area becomes unnecessary. The memory for the method area does not need to be contiguous.</p>
<p>方法区域是在<strong>虚拟机启动时创建</strong>的。尽管方法区域*<strong>在逻辑上是堆的一部分</strong>，但简单的实现可能会选择不收集或压实垃圾。该规范不要求方法区域的位置或用于管理编译代码的策略。方法区域可能具有固定尺寸，也可以根据计算的要求进行扩展，如果不需要较大的方法区域，则可能会收缩。方法区域的内存不需要连续。</p>
<hr>
<h3 id="1-5-2-组成"><a href="#1-5-2-组成" class="headerlink" title="1.5.2 组成"></a>1.5.2 组成</h3><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170008456.png" srcset="/img/loading.gif" lazyload alt="image-20220806170008456"></p>
<p>JDK1.8之前方法区用的实际上还是堆的内存；JDK1.8之后直接使用的操作系统的内存空间</p>
<hr>
<h3 id="1-5-3-方法区内存溢出"><a href="#1-5-3-方法区内存溢出" class="headerlink" title="1.5.3 方法区内存溢出"></a>1.5.3 方法区内存溢出</h3><p>内存不够都会溢出，只不过1.8之后使用操作系统的内存空间，很难溢出，可以自行设置大小；</p>
<hr>
<h3 id="1-5-4-StringTable"><a href="#1-5-4-StringTable" class="headerlink" title="1.5.4 StringTable"></a>1.5.4 StringTable</h3><h4 id="1-5-4-1-面试题"><a href="#1-5-4-1-面试题" class="headerlink" title="1.5.4.1 面试题"></a>1.5.4.1 面试题</h4><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170243400.png" srcset="/img/loading.gif" lazyload alt="image-20220806170243400"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170303658.png" srcset="/img/loading.gif" lazyload alt="image-20220806170303658"></p>
<p><strong>System.Out.println(s3 &#x3D;&#x3D; s4);   false</strong></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170354667.png" srcset="/img/loading.gif" lazyload alt="image-20220806170354667"></p>
<p><strong>System.Out.println(s3 &#x3D;&#x3D; s5);   true</strong></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170435116.png" srcset="/img/loading.gif" lazyload alt="image-20220806170435116"></p>
<p>简单来说，就是常量不会变；变量会新建；更详细解释看下节绿字</p>
<hr>
<h4 id="1-5-4-2-StringTable特性"><a href="#1-5-4-2-StringTable特性" class="headerlink" title="1.5.4.2 StringTable特性"></a>1.5.4.2 StringTable特性</h4><ul>
<li>常量池中的字符串仅是符号，第一次用到时才变为对象</li>
<li>字符串变量拼接的原理是 StringBuilder （1.8）</li>
<li>字符串常量拼接的原理是编译期优化</li>
<li>可以使用 intern 方法，主动将串池中还没有的字符串对象放入串池<ul>
<li>1.8 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</li>
<li>1.6 将这个字符串对象尝试放入串池，如果有则并不会放入，<strong>如果没有会把此对象复制一份（此时堆中的和串池中的已经不一样了）</strong>，放入串池， 会把串池中的对象返回</li>
<li>详细如下图</li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170806080.png" srcset="/img/loading.gif" lazyload alt="image-20220806170806080"></p>
<p>s仍然在堆中，复制了一份s放入串池并赋给s2；所以s2 &#x3D;&#x3D; x；s！&#x3D; x</p>
<p>在1.8中 没有复制而是直接放入，所以s2 &#x3D;&#x3D; x；s &#x3D;&#x3D; x</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170831409.png" srcset="/img/loading.gif" lazyload alt="image-20220806170831409"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170843063.png" srcset="/img/loading.gif" lazyload alt="image-20220806170843063"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806170853985.png" srcset="/img/loading.gif" lazyload alt="image-20220806170853985"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806171000537.png" srcset="/img/loading.gif" lazyload alt="image-20220806171000537"></p>
<hr>
<h4 id="1-5-4-3-StringTable位置"><a href="#1-5-4-3-StringTable位置" class="headerlink" title="1.5.4.3 StringTable位置"></a>1.5.4.3 StringTable位置</h4><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806171039427.png" srcset="/img/loading.gif" lazyload alt="image-20220806171039427"></p>
<p>1.8串池用的是堆空间，1.6用的是永久代空间</p>
<hr>
<h4 id="1-5-4-4-StringTable垃圾回收"><a href="#1-5-4-4-StringTable垃圾回收" class="headerlink" title="1.5.4.4 StringTable垃圾回收"></a>1.5.4.4 StringTable垃圾回收</h4><p>StrnigTable存在垃圾回收机制</p>
<hr>
<h4 id="1-5-4-5-StringTable性能调优"><a href="#1-5-4-5-StringTable性能调优" class="headerlink" title="1.5.4.5 StringTable性能调优"></a>1.5.4.5 StringTable性能调优</h4><p>调整 -XX:StringTableSize&#x3D;桶个数</p>
<p>桶的个数越多，哈希碰撞越少；因为每存放一个串时都要先查找当前StringTable中是否存在，若存在则不添加，不存在就添加；</p>
<p>如果存在字符串重复的问题，可以考虑将字符串入池，减少内存占用；</p>
<hr>
<h2 id="1-6-直接内存"><a href="#1-6-直接内存" class="headerlink" title="1.6 直接内存"></a>1.6 直接内存</h2><h3 id="1-6-1-定义"><a href="#1-6-1-定义" class="headerlink" title="1.6.1 定义"></a>1.6.1 定义</h3><p>Direct Memory</p>
<ul>
<li><p>常见于 NIO 操作时，用于数据缓冲区</p>
</li>
<li><p>分配回收成本较高，但读写性能高</p>
</li>
<li><p>不受 JVM 内存回收管理</p>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220806171447515.png" srcset="/img/loading.gif" lazyload alt="image-20220806171447515"></p>
<hr>
<h3 id="1-6-2-分配和回收原理"><a href="#1-6-2-分配和回收原理" class="headerlink" title="1.6.2 分配和回收原理"></a>1.6.2 分配和回收原理</h3><p>没太理解：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP?p=45">45_直接内存_释放原理_哔哩哔哩_bilibili</a></p>
<ul>
<li>使用了 Unsafe 对象完成直接内存的分配回收，并且回收需要<strong>主动调用</strong> freeMemory 方法</li>
<li>ByteBuffer 的实现类内部，使用了 Cleaner （虚引用）来监测 ByteBuffer 对象，一旦ByteBuffer 对象被垃圾回收，那么就会由 ReferenceHandler 线程通过 Cleaner 的 clean方法调 （弹幕：就是Java对象被垃圾回收会触发直接内存回收）</li>
<li>用 freeMemory 来释放直接内存</li>
</ul>
<hr>
<h1 id="2-垃圾回收"><a href="#2-垃圾回收" class="headerlink" title="2. 垃圾回收"></a>2. 垃圾回收</h1><h2 id="2-1-如何判断对象可以回收"><a href="#2-1-如何判断对象可以回收" class="headerlink" title="2.1 如何判断对象可以回收"></a>2.1 如何判断对象可以回收</h2><h3 id="2-1-1-引用计数法"><a href="#2-1-1-引用计数法" class="headerlink" title="2.1.1 引用计数法"></a>2.1.1 引用计数法</h3><p><strong>只要一个对象被其他变量所引用，就让它的计数加1</strong>，被引用了两次就让它的计数变成2，当这个变量的计数变成0时，就可以被垃圾回收；</p>
<p>弊端：当出现如下图的情况，A对象引用了B对象，B对象也引用了A对象，所以A，B的计数均为1，但是没有其他的引用它们俩；<strong>虽然应该被垃圾回收，但是因为计数不为0，则无法进行回收</strong></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811163138061.png" srcset="/img/loading.gif" lazyload alt="image-20220811163138061"></p>
<hr>
<h3 id="2-1-2-可达性计数法"><a href="#2-1-2-可达性计数法" class="headerlink" title="2.1.2 可达性计数法"></a>2.1.2 可达性计数法</h3><ul>
<li><p>Java 虚拟机中的垃圾回收器采用<strong>可达性分析</strong>来探索所有存活的对象</p>
</li>
<li><p>扫描堆中的对象，看是否能够沿着 <strong>GC Root对象（根对象）</strong> 为起点的引用链找到该对象，找不到，表示可以回收<strong>（就是先确定好一定不会被回收的对象作为根对象，然后查找目标对象是否直接或者间接被根对象所引用）</strong></p>
</li>
<li><p>哪些对象可以作为 GC Root ?</p>
<ul>
<li>GCRoot对象包括：虚拟机栈终点局部变量表引用的对象，方法区中类静态属性引用和常量引用对象，本地方法栈中的对象</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-1-3-五种引用-面试常考"><a href="#2-1-3-五种引用-面试常考" class="headerlink" title="2.1.3 五种引用(面试常考)"></a>2.1.3 五种引用(面试常考)</h3><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811163328291.png" srcset="/img/loading.gif" lazyload alt="image-20220811163328291"></p>
<h4 id="2-1-3-1-强引用"><a href="#2-1-3-1-强引用" class="headerlink" title="2.1.3.1 强引用"></a>2.1.3.1 强引用</h4><ul>
<li><p>只有所有 GC Roots 对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</p>
<p>如上图、只有B、C对象都不引用A1对象时，A1对象才会在垃圾回收时被回收；</p>
</li>
</ul>
<hr>
<h4 id="2-1-3-2-软引用（SoftReference）"><a href="#2-1-3-2-软引用（SoftReference）" class="headerlink" title="2.1.3.2 软引用（SoftReference）"></a>2.1.3.2 软引用（SoftReference）</h4><ul>
<li>仅有软引用引用该对象时，在垃圾回收后，内存仍不足时会<strong>再次</strong>出发垃圾回收，回收软引用对象（实在不行了才回收软引用对象）</li>
<li>可以配合引用队列来释放软引用自身（因为软引用对象自身也是占一点内存的）</li>
</ul>
<p><strong>软引用的使用</strong></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811163603544.png" srcset="/img/loading.gif" lazyload alt="image-20220811163603544"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811163628973.png" srcset="/img/loading.gif" lazyload alt="image-20220811163628973"></p>
<p>可见前四次已经被回收了；</p>
<p><strong>引用队列的使用</strong>：</p>
<p>如果在垃圾回收时发现内存不足，在回收软引用所指向的对象时，<strong>软引用本身不会被清理（就是上图结果中的null值）</strong></p>
<p>如果想要<strong>清理软引用</strong>，需要使<strong>用引用队列</strong></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811163843846.png" srcset="/img/loading.gif" lazyload alt="image-20220811163843846"></p>
<hr>
<h4 id="2-1-3-3-弱引用（WeakReference）"><a href="#2-1-3-3-弱引用（WeakReference）" class="headerlink" title="2.1.3.3 弱引用（WeakReference）"></a>2.1.3.3 弱引用（WeakReference）</h4><ul>
<li><p>仅有弱引用引用该对象时，在垃圾回收时，**(full gc时)无论内存是否充足<strong>，</strong>都会回收**弱引用对象</p>
</li>
<li><p>可以配合引用队列来释放弱引用自身</p>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164041023.png" srcset="/img/loading.gif" lazyload alt="image-20220811164041023"></p>
<p>结合引用队列同软引用相似</p>
<hr>
<h4 id="2-1-3-4-虚引用（PhantomReference）"><a href="#2-1-3-4-虚引用（PhantomReference）" class="headerlink" title="2.1.3.4 虚引用（PhantomReference）"></a>2.1.3.4 虚引用（PhantomReference）</h4><ul>
<li>必须配合引用队列使用，主要配合 ByteBuffer 使用，被引用对象回收时，会将虚引用入队由 Reference Handler 线程调用虚引用相关方法释放直接内存</li>
</ul>
<hr>
<h4 id="2-1-3-5-终结器引用（FinalReference）"><a href="#2-1-3-5-终结器引用（FinalReference）" class="headerlink" title="2.1.3.5 终结器引用（FinalReference）"></a>2.1.3.5 终结器引用（FinalReference）</h4><ul>
<li>无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由 Finalizer 线程通过终结器引用找到被引用对象并调用它的 finalize方法，第二次 GC 时才能回收被引用对象</li>
</ul>
<hr>
<h2 id="2-2-垃圾回收算法-重要"><a href="#2-2-垃圾回收算法-重要" class="headerlink" title="2.2 垃圾回收算法(重要)"></a>2.2 垃圾回收算法(重要)</h2><h3 id="2-2-1-标记清除算法"><a href="#2-2-1-标记清除算法" class="headerlink" title="2.2.1 标记清除算法"></a>2.2.1 标记清除算法</h3><p><strong>定义</strong>：标记清除算法顾名思义，是指在虚拟机执行垃圾回收的过程中，先采用标记算法确定可回收对象，然后垃圾收集器根据标识清除相应的内容，给堆内存腾出相应的空间</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164255455.png" srcset="/img/loading.gif" lazyload alt="image-20220811164255455"></p>
<p>清除后，对于腾出内存空间并不是将内存空间的字节清0，<strong>而是会把被清除对象所占用内存的起始结束的地址记录下来，放入空闲的地址列表中</strong>，下次分配内存的时候，再选择合适的位置存入，直接覆盖</p>
<p><strong>优点</strong>：速度快；</p>
<p><strong>缺点</strong>：容易产生大量的内存碎片，可能无法满足大对象的内存分配，一旦导致无法分配对象，那就会导致jvm启动gc，一旦启动gc，我们的应用程序就会暂停，这就导致应用的响应速度变慢</p>
<hr>
<h3 id="2-2-2-标记整理算法"><a href="#2-2-2-标记整理算法" class="headerlink" title="2.2.2 标记整理算法"></a>2.2.2 标记整理算法</h3><p>标记-整理 会将不被GC Root引用的对象回收，清楚其占用的内存空间。然后整理剩余的对象，<strong>速度慢、可以有效避免因内存碎片</strong>而导致的问题，但是因为整体需要消耗一定的时间，所以效率较低</p>
<hr>
<h3 id="2-2-3-复制算法"><a href="#2-2-3-复制算法" class="headerlink" title="2.2.3 复制算法"></a>2.2.3 复制算法</h3><p>复制算法将内存分为等大小的两个区域，FROM和TO（<strong>TO中始终为空</strong>）。先将被GC Root引用的对象从FROM放入TO中，再回收不被GC Root引用的对象。然后交换FROM和TO。这样也可以避免内存碎片的问题，但是会占用双倍的内存空间。</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164455902.png" srcset="/img/loading.gif" lazyload alt="image-20220811164455902"></p>
<hr>
<h2 id="2-3-分代垃圾回收"><a href="#2-3-分代垃圾回收" class="headerlink" title="2.3 分代垃圾回收"></a>2.3 分代垃圾回收</h2><h3 id="2-3-1回收流程"><a href="#2-3-1回收流程" class="headerlink" title="2.3.1回收流程"></a>2.3.1回收流程</h3><p>①  新创建的对象都被放在<strong>新生代的伊甸园</strong>中</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164541767.png" srcset="/img/loading.gif" lazyload alt="image-20220811164541767"></p>
<p>②  当伊甸园空间不足时，会采用<strong>复制算法</strong>进行垃圾回收，这时的回收叫做<strong>Minor GC</strong>；把<strong>伊甸园和幸存区From</strong>存活的对象先复制到幸存区To中，此时<strong>存活的对象寿命+1</strong>，并清理掉未存活的对象，最后再交换幸存区From和幸存区To；</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164612870.png" srcset="/img/loading.gif" lazyload alt="image-20220811164612870"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164720253.png" srcset="/img/loading.gif" lazyload alt="image-20220811164720253"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164727571.png" srcset="/img/loading.gif" lazyload alt="image-20220811164727571"></p>
<p>③  再次创建对象，若新生代的伊甸园又满了，则同上；</p>
<p>④ 如果经历多次垃圾回收，某一对象均未被回收，寿命不断+1，当寿命达到阈值时（最大为15，4bit）就会被放入老年代中；</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811164852925.png" srcset="/img/loading.gif" lazyload alt="image-20220811164852925"></p>
<p>⑤ 如果老年代中的内存都满了，就会先触发Minor GC 如果内存还是不足，则会触发<strong>Full GC</strong>，扫描<strong>新生代和老年代中</strong>所有不再使用的对象并回收、</p>
<p><strong>总结</strong></p>
<ul>
<li><p>对象首先分配在伊甸园区域</p>
</li>
<li><p>新生代空间不足时，触发 minor gc，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的对象年龄加 1并且交换 from to</p>
</li>
<li><p><strong>minor gc</strong> <strong>会引发 stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行</strong></p>
</li>
<li><p>当对象寿命超过阈值时，会晋升至老年代，最大寿命是15（4bit）</p>
</li>
<li><p>当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时间更长</p>
</li>
</ul>
<hr>
<h3 id="2-3-2-GC-分析"><a href="#2-3-2-GC-分析" class="headerlink" title="2.3.2 GC 分析"></a>2.3.2 GC 分析</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP?p=66">代码-GC分析</a></p>
<h4 id="2-3-2-1-大对象处理策略"><a href="#2-3-2-1-大对象处理策略" class="headerlink" title="2.3.2.1 大对象处理策略"></a>2.3.2.1 大对象处理策略</h4><p>当遇到一个<strong>较大的对象</strong>时，就算新生代的<strong>伊甸园</strong>为空，也<strong>无法容纳该对象</strong>时，会将该对象<strong>直接晋升为老年代</strong></p>
<hr>
<h4 id="2-3-2-2-线程内存溢出"><a href="#2-3-2-2-线程内存溢出" class="headerlink" title="2.3.2.2 线程内存溢出"></a>2.3.2.2 线程内存溢出</h4><p>某个线程的内存溢出了而抛异常（out of memory），不会让其他的线程结束运行</p>
<p>这是因为当一个线程<strong>抛出OOM异常后</strong>，<strong>它所占据的内存资源会全部被释放掉</strong>，从而不会影响其他线程的运行，<strong>进程依然正常</strong></p>
<hr>
<h2 id="2-4-垃圾回收器"><a href="#2-4-垃圾回收器" class="headerlink" title="2.4 垃圾回收器"></a>2.4 垃圾回收器</h2><p>串行</p>
<ul>
<li><p>单线程</p>
</li>
<li><p>堆内存较小，适合个人电脑</p>
</li>
</ul>
<hr>
<p>吞吐量优先</p>
<ul>
<li><p>多线程</p>
</li>
<li><p>堆内存较大，多核 cpu</p>
</li>
<li><p>让单位时间内，STW 的时间最短 0.2 0.2 &#x3D; 0.4，垃圾回收时间占比最低，这样就称吞吐量高<strong>（少餐多食）</strong></p>
</li>
</ul>
<hr>
<p>响应时间优先</p>
<ul>
<li><p>多线程</p>
</li>
<li><p>堆内存较大，多核 cpu</p>
</li>
<li><p>尽可能让单次 STW 的时间最短 0.1 0.1 0.1 0.1 0.1 &#x3D; 0.5<strong>（少食多餐）</strong></p>
</li>
</ul>
<hr>
<h3 id="2-4-1-串行"><a href="#2-4-1-串行" class="headerlink" title="2.4.1 串行"></a>2.4.1 串行</h3><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170019886.png" srcset="/img/loading.gif" lazyload alt="image-20220811170019886"></p>
<p><strong>安全点</strong>：</p>
<p>让其他线程都在这个点停下来，以免垃圾回收时移动对象地址，使得其他线程找不到被移动的对象；因为是串行的，所以只有一个垃圾回收线程。且在该线程执行回收工作时，其他线程进入<strong>阻塞</strong>状态</p>
<p><strong>Serial</strong> <strong>收集器</strong>：</p>
<p>Serial收集器是最基本的、发展历史最悠久的收集器</p>
<p>特点：单线程、简单高效（与其他收集器的单线程相比），用于新生代<strong>采用复制算法</strong>。对于限定单个CPU的环境来说，Serial收集器由于没有线程交互的开销，专心做垃圾收集自然可以获得最高的单线程手机效率。收集器进行垃圾回收时，<strong>必须暂停其他所有的工作线程，直到它结束（Stop The World）</strong></p>
<p><strong>Serial Old</strong> <strong>收集器</strong>：</p>
<p>Serial Old是Serial收集器的<strong>老年代</strong>版本</p>
<p>特点：同样是单线程收集器，<strong>采用标记-整理算法</strong></p>
<hr>
<h3 id="2-4-2-吞吐量优先"><a href="#2-4-2-吞吐量优先" class="headerlink" title="2.4.2 吞吐量优先"></a>2.4.2 吞吐量优先</h3><p><strong>-XX:+UseParallelGC ~ -XX:+UserParallelOldGC</strong>：</p>
<p>开启吞吐量优先的回收器，1.8版本默认开启；<strong>UseParallelGC是新生代的，采用复制算法；UserParallelOldGC是在老年代的，采用标记整理算法</strong></p>
<p> <img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811165910107.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>-XX:+UseAdaptiveSizePolicy</strong>：</p>
<p>开启这个将采用自适应的大小调整策略，调整新生代的大小，包括堆的大小和晋升老年代的阈值大小等；种调节方式称为<strong>GC的自适应调节策略</strong></p>
<p><strong>-XX:GCTimeRatio&#x3D;ratio</strong>：</p>
<p>调整吞吐量的目标，即垃圾回收的时间与总时间的占比（1&#x2F;(1+ratio)），默认ratio&#x3D;99，1&#x2F;(1+ratio)）&#x3D; 0.01，即垃圾回收的时间不能超过总时间的1%（比如总时间100分钟，垃圾回收的时间不能超过1分钟，如果超过1分钟，则GC会自适应的调整大小）</p>
<p><strong>-XX:MaxGCPauseMillis&#x3D;ms</strong>：</p>
<p>指的是暂停的毫秒数，默认200ms，即上图红线<strong>（和Ratio对立，折中选取）</strong></p>
<p><strong>-XX:ParallelGCThreads&#x3D;n</strong>：</p>
<p>设置垃圾回收时运行的线程数</p>
<hr>
<h3 id="2-4-3-响应时间优先（CMS）"><a href="#2-4-3-响应时间优先（CMS）" class="headerlink" title="2.4.3 响应时间优先（CMS）"></a>2.4.3 响应时间优先（CMS）</h3><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811165832530.png" srcset="/img/loading.gif" lazyload alt="image-20220811165832530"></p>
<p><strong>CMS</strong> <strong>收集器</strong></p>
<p><strong>Concurrent Mark Sweep</strong>，一种以获取<strong>最短回收停顿时间</strong>为目标的<strong>老年代</strong>收集器</p>
<p><strong>特点</strong>：基于<strong>标记-清除算法</strong>实现。并发收集、低停顿，但是会产生内存碎片</p>
<p><strong>应用场景</strong>：适用于注重服务的响应速度，希望系统停顿时间最短，给用户带来更好的体验等场景下。如web程序、b&#x2F;s服务</p>
<p><strong>CMS收集器的运行过程分为下列4步：</strong></p>
<p><strong>初始标记</strong>：标记GC Roots能直接到的对象。速度很快但是<strong>仍存在Stop The World问题</strong></p>
<p><strong>并发标记</strong>：进行GC Roots Tracing 的过程，找出存活对象且用户线程可并发执行</p>
<p><strong>重新标记</strong>：为了<strong>修正并发标记期间</strong>因用户程序继续运行而导致标记产生变动的那一部分对象的标记记录。仍然存在Stop The World问题</p>
<p><strong>并发清除</strong>：对标记的对象进行清除回收</p>
<blockquote>
<p>CMS收集器的内存回收过程是与用户线程一起<strong>并发执行</strong>的</p>
</blockquote>
<p>图解：</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170156714.png" srcset="/img/loading.gif" lazyload alt="image-20220811170156714"></p>
<hr>
<h3 id="2-4-4-G1-Garbage-First"><a href="#2-4-4-G1-Garbage-First" class="headerlink" title="2.4.4 G1(Garbage First)"></a>2.4.4 G1(Garbage First)</h3><p>JDK1.9默认采用G1垃圾回收器，且废弃的CMS回收器</p>
<h4 id="2-4-4-1-适用场景"><a href="#2-4-4-1-适用场景" class="headerlink" title="2.4.4.1 适用场景"></a>2.4.4.1 适用场景</h4><ul>
<li><p>同时注重吞吐量（Throughput）和低延时（Low latency），默认的暂停目标是200ms</p>
</li>
<li><p>超大堆内存，会将堆划分为多个大小相等的区域，称为Region，每个区域都可以独立的作为伊甸园或者新生代或者老年代</p>
</li>
<li><p>整体上是标记-整理算法，在两个区域之间是复制算法</p>
</li>
</ul>
<hr>
<h4 id="2-4-4-2-相关jvm参数"><a href="#2-4-4-2-相关jvm参数" class="headerlink" title="2.4.4.2 相关jvm参数"></a>2.4.4.2 相关jvm参数</h4><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170405861.png" srcset="/img/loading.gif" lazyload alt="image-20220811170405861"></p>
<hr>
<h4 id="2-4-4-3-G1垃圾回收阶段"><a href="#2-4-4-3-G1垃圾回收阶段" class="headerlink" title="2.4.4.3 G1垃圾回收阶段"></a>2.4.4.3 G1垃圾回收阶段</h4><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170444758.png" srcset="/img/loading.gif" lazyload alt="image-20220811170444758"></p>
<p>新生代伊甸园垃圾回收—–&gt;内存不足，新生代回收+并发标记—–&gt;回收新生代伊甸园、幸存区、老年代内存——&gt;新生代伊甸园垃圾回收(重新开始)</p>
<h5 id="Young-Collection"><a href="#Young-Collection" class="headerlink" title="Young Collection"></a>Young Collection</h5><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170657465.png" srcset="/img/loading.gif" lazyload alt="image-20220811170657465"></p>
<hr>
<h5 id="Young-Collection-CM"><a href="#Young-Collection-CM" class="headerlink" title="Young Collection + CM"></a>Young Collection + CM</h5><ul>
<li><p>在 Young GC 时会进行 GC Root 的初始标记</p>
</li>
<li><p>并发标记（CM）是从GC Root出发顺着其引用链标记其他对象</p>
</li>
<li><p>老年代占用堆空间比例达到阈值时，进行并发标记（不会 STW），由下面的 JVM 参数决定</p>
</li>
</ul>
<blockquote>
<p>-XX:InitiatingHeapOccupancyPercent&#x3D;percent （默认45%）<strong>如下图 O 占总的45%时进行并发标记</strong></p>
</blockquote>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170809004.png" srcset="/img/loading.gif" lazyload alt="image-20220811170809004"></p>
<hr>
<h5 id="Mixed-Collection"><a href="#Mixed-Collection" class="headerlink" title="Mixed Collection"></a>Mixed Collection</h5><p>会对 E、S、O <strong>进行全面垃圾回收</strong></p>
<p>最终标记（<strong>Remark见2.4.4.6</strong>）会 STW</p>
<p>拷贝存活（Evacuation）会 STW</p>
<p>-XX:MaxGCPauseMillis&#x3D;ms</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811170917470.png" srcset="/img/loading.gif" lazyload alt="image-20220811170917470"></p>
<p>黑线：即新生代回收，包括伊甸园、幸存区</p>
<p>红线：复制老年代</p>
<p><strong>问</strong>：为什么有的老年代被拷贝了，有的没拷贝？</p>
<p><strong>答：</strong>因为指定了最大停顿时间，如果对所有老年代都进行回收，耗时可能过高。为了保证时间不超过设定的停顿时间，会<strong>回收最有价值的老年代</strong>（回收后，能够得到更多内存）</p>
<hr>
<h4 id="2-4-4-4-Full-GC"><a href="#2-4-4-4-Full-GC" class="headerlink" title="2.4.4.4 Full GC"></a>2.4.4.4 Full GC</h4><p>G1在老年代内存不足时（老年代所占内存超过阈值）</p>
<p>如果垃圾产生速度<strong>慢于</strong>垃圾回收速度，不会触发Full GC，还是并发地进行清理</p>
<p>如果垃圾产生速度<strong>快于</strong>垃圾回收速度，便会触发Full GC，退化到串行，STW时间会很长</p>
<hr>
<h4 id="2-4-4-5-Young-Collection跨代引用"><a href="#2-4-4-5-Young-Collection跨代引用" class="headerlink" title="2.4.4.5 Young Collection跨代引用"></a>2.4.4.5 Young Collection跨代引用</h4><p>即老年代引用新生代的问题，因为在新生代回收过程中会沿着GC Root去标记，这些GC Root可能存在于老年代中，而一般老年代中的对象较多，这样每次都需要遍历大量对象；</p>
<p><strong>解决方法：</strong></p>
<ul>
<li><p>卡表与Remembered Set：</p>
<ul>
<li>Remembered Set 存在于E中，用于保存新生代对象对应的脏卡，将来对新生代进行垃圾回收时，会根据Remembered Set判断有哪些脏卡，然后再从这些脏卡开始<ul>
<li>脏卡：O被划分为多个区域（一个区域512K），如果该区域引用了新生代对象，则该区域被称为脏卡</li>
</ul>
</li>
</ul>
</li>
<li><p>在引用变更时通过post-write barried + dirty card queue，相当于更新脏卡</p>
</li>
<li><p>concurrent refinement threads 更新 Remembered Set</p>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171202341.png" srcset="/img/loading.gif" lazyload alt="image-20220811171202341"></p>
<hr>
<h4 id="2-4-4-6-Reamark重标记"><a href="#2-4-4-6-Reamark重标记" class="headerlink" title="2.4.4.6 Reamark重标记"></a>2.4.4.6 Reamark重标记</h4><p>黑色：已被处理，需要保留的 </p>
<p>灰色：正在处理中的 </p>
<p>白色：还未处理的</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171419280.png" srcset="/img/loading.gif" lazyload alt="image-20220811171419280"></p>
<p> ① 这个时候将处理B，处理结果如下：</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171445088.png" srcset="/img/loading.gif" lazyload alt="image-20220811171445088"></p>
<p>② 下一步将处理C，此时正在并发执行标记，用户线程可能改变B和C的引用关系，会产生如下情况：</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171506442.png" srcset="/img/loading.gif" lazyload alt="image-20220811171506442"></p>
<p>③ 此时C已经被处理完了，被标记成了白色，<strong>但是用户线程可能在这时又改变了C的引用：</strong></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171531614.png" srcset="/img/loading.gif" lazyload alt="image-20220811171531614"></p>
<p>④ 此时C应该被标记成黑色，但是标记动作已经结束，所以会产生误差；</p>
<p><strong>解决方法：采用Remark</strong></p>
<p>过程如下</p>
<p>①   之前C未被引用，这时A引用了C，就会给C加一个写屏障，写屏障的指令会被执行<strong>（只有发生引用改变就会执行）</strong>，将C放入一个队列当中，并将C变为 处理中 状态</p>
<p>②   在并发标记阶段结束以后，重新标记阶段会STW，然后将放在该队列中的对象重新处理发现有强引用引用它，就会处理它</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171613821.png" srcset="/img/loading.gif" lazyload alt="image-20220811171613821"></p>
<hr>
<h4 id="2-4-4-7-JDK8u20字符串去重"><a href="#2-4-4-7-JDK8u20字符串去重" class="headerlink" title="2.4.4.7 JDK8u20字符串去重"></a>2.4.4.7 JDK8u20字符串去重</h4><p><strong>过程</strong></p>
<p>①  将所有新分配的字符串（底层是char[]）放入一个队列</p>
<p>②  当新生代回收时，G1并发检查是否有重复的字符串</p>
<p>③  如果字符串的值一样，就让他们引用同一个字符串对象</p>
<p> <img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811171806398.png" srcset="/img/loading.gif" lazyload alt="image-20220811171806398"></p>
<p>注意，其与String.intern的区别</p>
<p><strong>intern关注的是字符串对象</strong></p>
<p>字符串去重关注的是<strong>char[]</strong></p>
<p>在JVM内部，使用了不同的字符串标</p>
<p><strong>优点与缺点</strong></p>
<ul>
<li><p>节省了大量内存</p>
</li>
<li><p>新生代回收时间略微增加，导致略微多占用CPU</p>
</li>
</ul>
<hr>
<h4 id="2-4-4-8-JDK-8u40-并发标记类卸载"><a href="#2-4-4-8-JDK-8u40-并发标记类卸载" class="headerlink" title="2.4.4.8 JDK 8u40 并发标记类卸载"></a>2.4.4.8 JDK 8u40 并发标记类卸载</h4><p>在并发标记阶段结束以后，就能知道哪些类不再被使用。如果一个类加载器的所有类都不在使用，则卸载它所加载的所有类</p>
<p>-XX:+ClassUnloadingWithConcurrentMark 默认启用</p>
<hr>
<h4 id="2-4-4-9-JDK-8u60-回收巨型对象"><a href="#2-4-4-9-JDK-8u60-回收巨型对象" class="headerlink" title="2.4.4.9 JDK 8u60 回收巨型对象"></a>2.4.4.9 JDK 8u60 回收巨型对象</h4><ul>
<li>一个对象大于region的一半时，就称为巨型对象</li>
<li>G1不会对巨型对象进行拷贝</li>
<li>回收时被优先考虑</li>
<li>G1会跟踪老年代所有incoming引用，如果老年代incoming引用为0的巨型对象就可以在新生代垃圾回收时处理掉</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220811172031981.png" srcset="/img/loading.gif" lazyload alt="image-20220811172031981"></p>
<hr>
<h4 id="2-4-4-10-JDK9并发标记起始时间的调整"><a href="#2-4-4-10-JDK9并发标记起始时间的调整" class="headerlink" title="2.4.4.10 JDK9并发标记起始时间的调整"></a>2.4.4.10 JDK9并发标记起始时间的调整</h4><p>2.4.4.4提到当垃圾产生速度快于垃圾回收速度，便会触发Full GC，STW的时间就会变长，这个时候就可以通过调整<strong>提前开始</strong>并发标记来优化</p>
<ul>
<li><p>并发标记必须在堆空间占满前完成，否则退化为 FullGC</p>
</li>
<li><p>JDK 9 之前需要使用 -XX:InitiatingHeapOccupancyPercent</p>
</li>
<li><p>JDK 9 可以动态调整</p>
</li>
</ul>
<p>-XX:InitiatingHeapOccupancyPercent 用来设置初始值</p>
<p>进行数据采样并动态调整</p>
<p>总会添加一个安全的空档空间</p>
<hr>
<h2 id="2-5-垃圾回收调优"><a href="#2-5-垃圾回收调优" class="headerlink" title="2.5 垃圾回收调优"></a>2.5 垃圾回收调优</h2><h3 id="2-5-1-确定调优领域"><a href="#2-5-1-确定调优领域" class="headerlink" title="2.5.1 确定调优领域"></a>2.5.1 确定调优领域</h3><ul>
<li>内存</li>
<li>锁竞争</li>
<li>CPU占用</li>
<li>IO</li>
<li>GC</li>
</ul>
<hr>
<h3 id="2-5-2确定目标"><a href="#2-5-2确定目标" class="headerlink" title="2.5.2确定目标"></a>2.5.2确定目标</h3><p>低延迟&#x2F;高吞吐量？ 选择合适的GC</p>
<ul>
<li>CMS(JDK8默认)、 G1(JDK9推荐) 、ZGC(JDK12体验)</li>
<li>ParallelGC（高吞吐量）</li>
<li>Zing（另一种虚拟机）</li>
</ul>
<hr>
<h3 id="2-5-3最快的GC是不发生GC"><a href="#2-5-3最快的GC是不发生GC" class="headerlink" title="2.5.3最快的GC是不发生GC"></a>2.5.3最快的GC是不发生GC</h3><p>首先排除减少因为自身编写的代码而引发的内存问题</p>
<ul>
<li><p>查看Full GC前后的内存占用，考虑以下几个问题</p>
</li>
<li><ul>
<li><p>数据是不是太多？（比如select *）</p>
</li>
<li><p>数据表示是否太臃肿</p>
</li>
<li><ul>
<li>对象图</li>
<li>对象大小（比如用Integer换成int会小很多）</li>
</ul>
</li>
<li><p>是否存在内存泄漏（采用软、弱引用；第三方缓存实现等）</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="2-5-4新生代调优"><a href="#2-5-4新生代调优" class="headerlink" title="2.5.4新生代调优"></a>2.5.4新生代调优</h3><p><strong>新生代的特点</strong></p>
<ul>
<li><p>所有的new操作分配内存都是非常廉价的</p>
</li>
<li><p>死亡对象回收零代价</p>
</li>
</ul>
<ul>
<li>大部分对象用过即死（朝生夕死）</li>
</ul>
<ul>
<li>MInor GC 所用时间远小于Full GC</li>
</ul>
<p>问：新生代内存越大越好么？</p>
<p>答：不是</p>
<ul>
<li><p>新生代内存太小：频繁触发Minor GC，会STW，会使得吞吐量下降</p>
</li>
<li><p>新生代内存太大：老年代内存占比有所降低，会更频繁地触发Full GC。而且触发Minor GC时，清理新生代所花费的时间会更长</p>
</li>
<li><p>新生代内存设置为能容纳所有【并发量*(请求-响应)】的数据为宜</p>
</li>
</ul>
<hr>
<h3 id="2-5-5幸存区调优"><a href="#2-5-5幸存区调优" class="headerlink" title="2.5.5幸存区调优"></a>2.5.5幸存区调优</h3><ul>
<li><p>幸存区需要能够保存 <strong>当前活跃对象+需要晋升的对象</strong></p>
</li>
<li><p>晋升阈值配置得当，让长时间存活的对象尽快晋升</p>
</li>
</ul>
<p>-XX:MaxTenuringThreshold&#x3D;threshold<br> -XX:+PrintTenuringDistribution</p>
<hr>
<h3 id="2-5-6老年代调优"><a href="#2-5-6老年代调优" class="headerlink" title="2.5.6老年代调优"></a>2.5.6老年代调优</h3><p>以 CMS 为例</p>
<ul>
<li><p>CMS 的老年代内存越大越好</p>
</li>
<li><p>先尝试不做调优，如果没有 Full GC 那么已经…，否则先尝试调优新生代</p>
</li>
<li><p>观察发生 Full GC 时老年代内存占用，将老年代内存预设调大 1&#x2F;4 ~ 1&#x2F;3</p>
</li>
</ul>
<p>-XX:CMSInitiatingOccupancyFraction&#x3D;percent</p>
<h1 id="3-类加载与字节码技术"><a href="#3-类加载与字节码技术" class="headerlink" title="3. 类加载与字节码技术"></a>3. 类加载与字节码技术</h1><h2 id="3-1-类文件结构"><a href="#3-1-类文件结构" class="headerlink" title="3.1 类文件结构"></a>3.1 类文件结构</h2><p>首先获得.class字节码文件</p>
<p>方法：</p>
<ul>
<li>在文本文档里写入java代码（文件名与类名一致），将文件类型改为.java</li>
<li>java终端中，执行javac X:…\XXX.java</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220808172918938.png" srcset="/img/loading.gif" lazyload alt="image-20220808172918938"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// HelloWorld 示例</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    	System.out.println(<span class="hljs-string">&quot;hello world&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>以下是字节码文件</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0000000</span> ca fe ba be <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">23</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">09</span> <br><span class="hljs-attribute">0000020</span> <span class="hljs-number">00</span> <span class="hljs-number">16</span> <span class="hljs-number">00</span> <span class="hljs-number">17</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">18</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">19</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>a <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>b <span class="hljs-number">07</span> <br><span class="hljs-attribute">0000040</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>c <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">3</span>c <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">3</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">28</span> <span class="hljs-number">29</span> <br><span class="hljs-attribute">0000060</span> <span class="hljs-number">56</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">43</span> <span class="hljs-number">6</span>f <span class="hljs-number">64</span> <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>f <span class="hljs-number">4</span>c <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">65</span> <span class="hljs-number">4</span>e <br><span class="hljs-attribute">0000100</span> <span class="hljs-number">75</span> <span class="hljs-number">6</span>d <span class="hljs-number">62</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">54</span> <span class="hljs-number">61</span> <span class="hljs-number">62</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">12</span> <span class="hljs-number">4</span>c <span class="hljs-number">6</span>f <span class="hljs-number">63</span> <br><span class="hljs-attribute">0000120</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>c <span class="hljs-number">56</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> <span class="hljs-number">62</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">54</span> <span class="hljs-number">61</span> <span class="hljs-number">62</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">01</span> <br><span class="hljs-attribute">0000140</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">74</span> <span class="hljs-number">68</span> <span class="hljs-number">69</span> <span class="hljs-number">73</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>d <span class="hljs-number">4</span>c <span class="hljs-number">63</span> <span class="hljs-number">6</span>e <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">74</span> <span class="hljs-number">63</span> <br><span class="hljs-attribute">0000160</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>a <span class="hljs-number">76</span> <span class="hljs-number">6</span>d <span class="hljs-number">2</span>f <span class="hljs-number">74</span> <span class="hljs-number">35</span> <span class="hljs-number">2</span>f <span class="hljs-number">48</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">6</span>f <br><span class="hljs-attribute">0000200</span> <span class="hljs-number">57</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span> <span class="hljs-number">3</span>b <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">6</span>d <span class="hljs-number">61</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">16</span> <br><span class="hljs-attribute">0000220</span> <span class="hljs-number">28</span> <span class="hljs-number">5</span>b <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <br><span class="hljs-attribute">0000240</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b <span class="hljs-number">29</span> <span class="hljs-number">56</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">67</span> <span class="hljs-number">73</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">13</span> <br><span class="hljs-attribute">0000260</span> <span class="hljs-number">5</span>b <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <br><span class="hljs-attribute">0000300</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">4</span>d <span class="hljs-number">65</span> <span class="hljs-number">74</span> <span class="hljs-number">68</span> <span class="hljs-number">6</span>f <span class="hljs-number">64</span> <span class="hljs-number">50</span> <span class="hljs-number">61</span> <span class="hljs-number">72</span> <span class="hljs-number">61</span> <br><span class="hljs-attribute">0000320</span> <span class="hljs-number">6</span>d <span class="hljs-number">65</span> <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">73</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <span class="hljs-number">53</span> <span class="hljs-number">6</span>f <span class="hljs-number">75</span> <span class="hljs-number">72</span> <span class="hljs-number">63</span> <span class="hljs-number">65</span> <span class="hljs-number">46</span> <br><span class="hljs-attribute">0000340</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>c <span class="hljs-number">65</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>f <span class="hljs-number">48</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">6</span>f <span class="hljs-number">57</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span><br><span class="hljs-attribute">0000360</span> <span class="hljs-number">2</span>e <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>d <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">1</span>e <br><span class="hljs-attribute">0000400</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>f <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>b <span class="hljs-number">68</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">6</span>f <span class="hljs-number">20</span> <span class="hljs-number">77</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span> <br><span class="hljs-attribute">0000420</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">22</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">1</span>b <span class="hljs-number">63</span> <span class="hljs-number">6</span>e <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">74</span> <br><span class="hljs-attribute">0000440</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>a <span class="hljs-number">76</span> <span class="hljs-number">6</span>d <span class="hljs-number">2</span>f <span class="hljs-number">74</span> <span class="hljs-number">35</span> <span class="hljs-number">2</span>f <span class="hljs-number">48</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <br><span class="hljs-attribute">0000460</span> <span class="hljs-number">6</span>f <span class="hljs-number">57</span> <span class="hljs-number">6</span>f <span class="hljs-number">72</span> <span class="hljs-number">6</span>c <span class="hljs-number">64</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <br><span class="hljs-attribute">0000500</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">4</span>f <span class="hljs-number">62</span> <span class="hljs-number">6</span>a <span class="hljs-number">65</span> <span class="hljs-number">63</span> <span class="hljs-number">74</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <br><span class="hljs-attribute">0000520</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">6</span>d <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">6</span>f <br><span class="hljs-attribute">0000540</span> <span class="hljs-number">75</span> <span class="hljs-number">74</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">6</span>f <span class="hljs-number">2</span>f <span class="hljs-number">50</span> <span class="hljs-number">72</span> <br><span class="hljs-attribute">0000560</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span> <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>d <span class="hljs-number">3</span>b <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">13</span> <span class="hljs-number">6</span>a <span class="hljs-number">61</span> <span class="hljs-number">76</span> <br><span class="hljs-attribute">0000600</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">69</span> <span class="hljs-number">6</span>f <span class="hljs-number">2</span>f <span class="hljs-number">50</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span> <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> <span class="hljs-number">6</span>d <br><span class="hljs-attribute">0000620</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">70</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">74</span> <span class="hljs-number">6</span>c <span class="hljs-number">6</span>e <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">15</span> <span class="hljs-number">28</span> <span class="hljs-number">4</span>c <span class="hljs-number">6</span>a <br><span class="hljs-attribute">0000640</span> <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> <span class="hljs-number">2</span>f <span class="hljs-number">6</span>c <span class="hljs-number">61</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">2</span>f <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span> <span class="hljs-number">3</span>b <br><span class="hljs-attribute">0000660</span> <span class="hljs-number">29</span> <span class="hljs-number">56</span> <span class="hljs-number">00</span> <span class="hljs-number">21</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <br><span class="hljs-attribute">0000700</span> <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">2</span>f <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <br><span class="hljs-attribute">0000720</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">2</span>a b7 <span class="hljs-number">00</span> <span class="hljs-number">01</span> b1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <br><span class="hljs-attribute">0000740</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>b <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <br><span class="hljs-attribute">0000760</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">0</span>d <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>e <span class="hljs-number">00</span> <br><span class="hljs-attribute">0001000</span> <span class="hljs-number">0</span>f <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">37</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br><span class="hljs-attribute">0001020</span> <span class="hljs-number">09</span> b2 <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">12</span> <span class="hljs-number">03</span> b6 <span class="hljs-number">00</span> <span class="hljs-number">04</span> b1 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <br><span class="hljs-attribute">0001040</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>a <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>b <br><span class="hljs-attribute">0001060</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">0</span>c <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">09</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">11</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <br><span class="hljs-attribute">0001100</span> <span class="hljs-number">00</span> <span class="hljs-number">12</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">13</span> <span class="hljs-number">00</span> <br><span class="hljs-attribute">0001120</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">02</span> <span class="hljs-number">00</span> <span class="hljs-number">14</span>Copy<br></code></pre></td></tr></table></figure>

<p>根据 JVM 规范，<strong>类文件结构</strong>如下</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs abnf">u4 			 	  magic<br>u2           	  minor_version<span class="hljs-comment">;    </span><br>u2           	  major_version<span class="hljs-comment">;    </span><br>u2           	  constant_pool_count<span class="hljs-comment">;    </span><br>cp_info      	  constant_pool[constant_pool_count-<span class="hljs-number">1</span>]<span class="hljs-comment">;    </span><br>u2           	  access_flags<span class="hljs-comment">;    </span><br>u2           	  this_class<span class="hljs-comment">;    </span><br>u2           	  super_class<span class="hljs-comment">;   </span><br>u2           	  interfaces_count<span class="hljs-comment">;    </span><br>u2           	  interfaces[interfaces_count]<span class="hljs-comment">;   </span><br>u2           	  fields_count<span class="hljs-comment">;    </span><br>field_info   	  fields[fields_count]<span class="hljs-comment">;   </span><br>u2           	  methods_count<span class="hljs-comment">;    </span><br>method_info  	  methods[methods_count]<span class="hljs-comment">;    </span><br>u2           	  attributes_count<span class="hljs-comment">;    </span><br>attribute_info 	  attributes[attributes_count]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>



<h3 id="3-1-1-魔数"><a href="#3-1-1-魔数" class="headerlink" title="3.1.1 魔数"></a>3.1.1 魔数</h3><p>u4 magic</p>
<p>对应字节码文件的0~3个字节</p>
<p>0000000 <strong>ca fe ba be</strong> 00 00 00 34 00 23 0a 00 06 00 15 09</p>
<hr>
<h3 id="3-1-2-版本"><a href="#3-1-2-版本" class="headerlink" title="3.1.2 版本"></a>3.1.2 版本</h3><p>u2 minor_version;</p>
<p>u2 major_version;</p>
<p>0000000 ca fe ba be <strong>00 00 00 34</strong> 00 23 0a 00 06 00 15 09</p>
<p>34H &#x3D; 52，代表JDK8</p>
<hr>
<h3 id="3-1-3-常量池"><a href="#3-1-3-常量池" class="headerlink" title="3.1.3 常量池"></a>3.1.3 常量池</h3><p>了解即可</p>
<blockquote>
<p>查看文档阅读：<a target="_blank" rel="noopener" href="https://gitee.com/Gu-taicheng/image/raw/master/document/3_%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%8A%80%E6%9C%AF.pdf">https://gitee.com/Gu-taicheng/image/raw/master/document/3_%E7%B1%BB%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%AD%97%E8%8A%82%E7%A0%81%E6%8A%80%E6%9C%AF.pdf</a></p>
</blockquote>
<hr>
<h2 id="3-2-字节码指令"><a href="#3-2-字节码指令" class="headerlink" title="3.2 字节码指令"></a>3.2 字节码指令</h2><h3 id="3-2-1-javap工具"><a href="#3-2-1-javap工具" class="headerlink" title="3.2.1 javap工具"></a>3.2.1 javap工具</h3><p>自己分析类文件结构太麻烦了，Oracle提供了<strong>javap工具</strong>来反编译class文件</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">javap -v D:\<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Main</span>.</span></span><span class="hljs-keyword">class</span><br></code></pre></td></tr></table></figure>

<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs lasso">C:\Thread_study&gt;javap <span class="hljs-params">-v</span> D:\Main.class<br>Classfile /D:\Main.class<br>  Last modified <span class="hljs-number">2020</span><span class="hljs-number">-6</span><span class="hljs-number">-6</span>; size <span class="hljs-number">434</span> <span class="hljs-built_in">bytes</span><br>  MD5 checksum df1dce65bf6fb0b4c1de318051f4a67e<br>  Compiled from <span class="hljs-string">&quot;Demo1.java&quot;</span><br><span class="hljs-keyword">public</span> class com.nyima.JVM.day5.Demo1<br>  minor version: <span class="hljs-number">0</span><br>  major version: <span class="hljs-number">52</span><br>  flags: ACC_PUBLIC, ACC_SUPER<br>Constant pool:<br>   #1 = Methodref          #6.#15         <span class="hljs-comment">// java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   #2 = Fieldref           #16.#17        <span class="hljs-comment">// java/lang/System.out:Ljava/io/PrintStream;</span><br>   #3 = <span class="hljs-built_in">String</span>             #18            <span class="hljs-comment">// hello world</span><br>   #4 = Methodref          #19.#20        <span class="hljs-comment">// java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>   #5 = Class              #21            <span class="hljs-comment">// com/nyima/JVM/day5/Demo1</span><br>   #6 = Class              #22            <span class="hljs-comment">// java/lang/Object</span><br>   #7 = Utf8               &lt;init&gt;<br>   #8 = Utf8               ()V<br>   #9 = Utf8               Code<br>  #10 = Utf8               LineNumberTable<br>  #11 = Utf8               main<br>  #12 = Utf8               (<span class="hljs-meta">[</span>Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>  #13 = Utf8               SourceFile<br>  #14 = Utf8               Demo1.java<br>  #15 = NameAndType        #7:#8          <span class="hljs-comment">// &quot;&lt;init&gt;&quot;:()V</span><br>  #16 = Class              #23            <span class="hljs-comment">// java/lang/System</span><br>  #17 = NameAndType        #24:#25        <span class="hljs-comment">// out:Ljava/io/PrintStream;</span><br>  #18 = Utf8               hello world<br>  #19 = Class              #26            <span class="hljs-comment">// java/io/PrintStream</span><br>  #20 = NameAndType        #27:#28        <span class="hljs-comment">// println:(Ljava/lang/String;)V</span><br>  #21 = Utf8               com/nyima/JVM/day5/Demo1<br>  #22 = Utf8               java/lang/Object<br>  #23 = Utf8               java/lang/System<br>  #24 = Utf8               out<br>  #25 = Utf8               Ljava/io/PrintStream;<br>  #26 = Utf8               java/io/PrintStream<br>  #27 = Utf8               println<br>  #28 = Utf8               (Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>&#123;<br>  <span class="hljs-keyword">public</span> com.nyima.JVM.day5.Demo1();<br>    descriptor: ()V<br>    flags: ACC_PUBLIC<br>    Code:<br>      <span class="hljs-built_in">stack</span>=<span class="hljs-number">1</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: aload_0<br>         <span class="hljs-number">1</span>: invokespecial #1                  <span class="hljs-comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>         <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">7</span>: <span class="hljs-number">0</span><br><br>  <span class="hljs-keyword">public</span> static <span class="hljs-literal">void</span> main(java.lang.<span class="hljs-built_in">String</span><span class="hljs-meta">[</span><span class="hljs-meta">]</span>);<br>    descriptor: (<span class="hljs-meta">[</span>Ljava/lang/<span class="hljs-built_in">String</span>;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>      <span class="hljs-built_in">stack</span>=<span class="hljs-number">2</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: getstatic     #2                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br>         <span class="hljs-number">3</span>: ldc           #3                  <span class="hljs-comment">// String hello world</span><br>         <span class="hljs-number">5</span>: invokevirtual #4                  <span class="hljs-comment">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><br>         <span class="hljs-number">8</span>: <span class="hljs-keyword">return</span><br>      LineNumberTable:<br>        line <span class="hljs-number">9</span>: <span class="hljs-number">0</span><br>        line <span class="hljs-number">10</span>: <span class="hljs-number">8</span><br>&#125;Copy<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-2-2-图解方法执行流程"><a href="#3-2-2-图解方法执行流程" class="headerlink" title="3.2.2 图解方法执行流程"></a>3.2.2 图解方法执行流程</h3><p><strong>原始代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_1</span> &#123;    <br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;        <br>		<span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;        <br>		<span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> Short.MAX_VALUE + <span class="hljs-number">1</span>;        <br>		<span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;        <br>		System.out.println(c);   <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="3-2-2-1-常量池载入运行时常量池"><a href="#3-2-2-1-常量池载入运行时常量池" class="headerlink" title="3.2.2.1 常量池载入运行时常量池"></a>3.2.2.1 常量池载入运行时常量池</h4><p>常量池也属于方法区，只不过这里单独提出来了</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220808184345213.png" srcset="/img/loading.gif" lazyload alt="image-20220808184345213"></p>
<h4 id="3-2-2-2-方法字节码载入方法区"><a href="#3-2-2-2-方法字节码载入方法区" class="headerlink" title="3.2.2.2 方法字节码载入方法区"></a>3.2.2.2 方法字节码载入方法区</h4><p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220808184729286.png" srcset="/img/loading.gif" lazyload alt="image-20220808184729286"></p>
<h4 id="3-2-2-3-main-线程开始运行，分配栈帧内存"><a href="#3-2-2-3-main-线程开始运行，分配栈帧内存" class="headerlink" title="3.2.2.3 main 线程开始运行，分配栈帧内存"></a>3.2.2.3 main 线程开始运行，分配栈帧内存</h4><p>（stack&#x3D;2，locals&#x3D;4） 对应操作数栈有2个空间（每个空间4个字节），局部变量表中有4个槽位</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220808184801651.png" srcset="/img/loading.gif" lazyload alt="image-20220808184801651"></p>
<h4 id="3-2-2-4-执行引擎开始执行字节码"><a href="#3-2-2-4-执行引擎开始执行字节码" class="headerlink" title="3.2.2.4 执行引擎开始执行字节码"></a>3.2.2.4 执行引擎开始执行字节码</h4><h5 id="bipush-10"><a href="#bipush-10" class="headerlink" title="bipush 10"></a>bipush 10</h5><ul>
<li><p>将一个 byte 压入操作数栈</p>
<p>（其长度会补齐 4 个字节），类似的指令还有</p>
<ul>
<li>sipush 将一个 short 压入操作数栈（其长度会补齐 4 个字节）</li>
<li>ldc 将一个 int 压入操作数栈</li>
<li>ldc2_w 将一个 long 压入操作数栈（<strong>分两次压入</strong>，因为 long 是 8 个字节）</li>
<li>这里小的数字都是和字节码指令存在一起，<strong>超过 short 范围的数字存入了常量池(比如Short.MAX_VALUE + 1)</strong></li>
</ul>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809002236917.png" srcset="/img/loading.gif" lazyload alt="image-20220809002236917"></p>
<h5 id="istore-1"><a href="#istore-1" class="headerlink" title="istore_1"></a>istore_1</h5><p>将操作数栈栈顶元素弹出，放入局部变量表的slot 1中</p>
<p>对应代码中的</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809002349798.png" srcset="/img/loading.gif" lazyload alt="image-20220809002349798"></p>
<h5 id="ldc-3"><a href="#ldc-3" class="headerlink" title="ldc #3"></a>ldc #3</h5><ul>
<li><p>读取运行时常量池中#3，即32768(超过short最大值范围的数会被放到运行时常量池中)，将其加载到操作数栈中</p>
</li>
<li><p><strong>注意 Short.MAX_VALUE 是 32767</strong>，所以 32768 &#x3D; Short.MAX_VALUE + 1 实际是在编译期间计算好的、</p>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809002547059.png" srcset="/img/loading.gif" lazyload alt="image-20220809002547059"></p>
<h5 id="istore-2"><a href="#istore-2" class="headerlink" title="istore_2"></a>istore_2</h5><p>将操作数栈中的元素弹出，放到局部变量表的2号位置</p>
<p>对应着代码中的</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">32768</span><br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809002645260.png" srcset="/img/loading.gif" lazyload alt="image-20220809002645260"></p>
<h5 id="iload1、iload2"><a href="#iload1、iload2" class="headerlink" title="iload1、iload2"></a>iload1、iload2</h5><p>将局部变量表中1号位置和2号位置的元素放入操作数栈中</p>
<ul>
<li>因为只能在操作数栈中执行运算操作</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809002922739.png" srcset="/img/loading.gif" lazyload alt="image-20220809002922739"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809002935532.png" srcset="/img/loading.gif" lazyload alt="image-20220809002935532"></p>
<h5 id="iadd"><a href="#iadd" class="headerlink" title="iadd"></a>iadd</h5><p>将操作数栈中的两个元素<strong>弹出栈</strong>并相加，结果在压入操作数栈中</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809003051071.png" srcset="/img/loading.gif" lazyload alt="image-20220809003051071"></p>
<h5 id="istore-3"><a href="#istore-3" class="headerlink" title="istore 3"></a>istore 3</h5><p>将操作数栈中的元素弹出，放入局部变量表的3号位置</p>
<p>对应代码中的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> a + b;<br></code></pre></td></tr></table></figure>

<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809003148724.png" srcset="/img/loading.gif" lazyload alt="image-20220809003148724"></p>
<h5 id="getstatic-4"><a href="#getstatic-4" class="headerlink" title="getstatic #4"></a>getstatic #4</h5><ul>
<li><p>在运行时常量池中找到#4，发现是一个对象</p>
</li>
<li><p>在堆内存中找到该对象，并将其<strong>引用</strong>放入操作数栈中</p>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809003412248.png" srcset="/img/loading.gif" lazyload alt="image-20220809003412248"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809003428927.png" srcset="/img/loading.gif" lazyload alt="image-20220809003428927"></p>
<h5 id="iload-3"><a href="#iload-3" class="headerlink" title="iload 3"></a>iload 3</h5><p>将局部变量表中3号位置的元素压入操作数栈中</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809003627971.png" srcset="/img/loading.gif" lazyload alt="image-20220809003627971"></p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809003902007.png" srcset="/img/loading.gif" lazyload alt="image-20220809003902007"></p>
<h5 id="invokevirtual-5"><a href="#invokevirtual-5" class="headerlink" title="invokevirtual 5"></a>invokevirtual 5</h5><ul>
<li>找到常量池 #5 项</li>
<li>定位到方法区 java&#x2F;io&#x2F;PrintStream.println:(I)V 方法</li>
<li>生成新的栈帧（分配 locals、stack等）</li>
<li>传递参数，执行新栈帧中的字节码</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809004000867.png" srcset="/img/loading.gif" lazyload alt="image-20220809004000867"></p>
<ul>
<li>执行完毕，弹出栈帧</li>
<li>清除 main 操作数栈内容</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220809004022928.png" srcset="/img/loading.gif" lazyload alt="image-20220809004022928"></p>
<h5 id="return"><a href="#return" class="headerlink" title="return"></a>return</h5><ul>
<li>完成 main 方法调用</li>
<li>弹出 main 栈帧，程序结束</li>
</ul>
<hr>
<h3 id="3-2-3-练习-分析i"><a href="#3-2-3-练习-分析i" class="headerlink" title="3.2.3 练习-分析i++"></a>3.2.3 练习-分析i++</h3><p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 从字节码角度分析 a++ 相关题目</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a++ + ++a + a--;<br>        System.out.println(a);<br>        System.out.println(b);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>字节码code：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-number">0</span>: bipush <span class="hljs-number">10</span><br> <span class="hljs-number">2</span>: istore_1<br> <span class="hljs-number">3</span>: iload_1<br> <span class="hljs-number">4</span>: iinc <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br> <span class="hljs-number">7</span>: iinc <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br><span class="hljs-number">10</span>: iload_1<br><span class="hljs-number">11</span>: iadd<br><span class="hljs-number">12</span>: iload_1<br><span class="hljs-number">13</span>: iinc <span class="hljs-number">1</span>, -<span class="hljs-number">1</span><br><span class="hljs-number">16</span>: iadd<br><span class="hljs-number">17</span>: istore_2<br></code></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>注意**iinc指令(自增指令)**是直接在局部变量slot上进行运算</li>
<li>a++ 和 ++a 的区别是先执行**iload(读取)**还是先执行iinc<ul>
<li>a++ 是先 iload 再 iinc</li>
<li>++a 是先 iinc 再 iload</li>
</ul>
</li>
</ul>
<p>结论：</p>
<p>图解过长，计算出后观看视频验证答案</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP?p=112">https://www.bilibili.com/video/BV1yE411Z7AP?p=112</a></p>
<hr>
<h3 id="3-2-4-条件判断"><a href="#3-2-4-条件判断" class="headerlink" title="3.2.4 条件判断"></a>3.2.4 条件判断</h3><p>几点说明：</p>
<ul>
<li>byte，short，char 都会按 int 比较，因为操作数栈都是 4 字节</li>
<li>goto 用来进行跳转到指定行号的字节码</li>
</ul>
<p>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(a == <span class="hljs-number">0</span>) &#123;<br>        	a = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        	a = <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>字节码code</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">0</span>: iconst_0	 <span class="hljs-comment">//把 0 压入操作数栈 （比较小的数 -1到5用iconst）</span><br><span class="hljs-number">1</span>: istore_1  <span class="hljs-comment">//把这个 0 赋值给 a（局部变量1号位） 即 a = 0;</span><br><span class="hljs-number">2</span>: iload_1  <span class="hljs-comment">//把局部变量表1号位的值读取到操作数栈</span><br><span class="hljs-number">3</span>: ifne <span class="hljs-number">12</span>  <span class="hljs-comment">// 判断 如果不成立（这里即a不等于0）则跳转到12行，如果等于则继续往下</span><br><span class="hljs-number">6</span>: bipush <span class="hljs-number">10</span>  <span class="hljs-comment">//把 10 放入操作数栈</span><br><span class="hljs-number">8</span>: istore_1   <span class="hljs-comment">//把 10 赋值给 a</span><br><span class="hljs-number">9</span>: goto <span class="hljs-number">15</span>   <span class="hljs-comment">// 跳转到15行</span><br><span class="hljs-number">12</span>: bipush <span class="hljs-number">20</span> <span class="hljs-comment">//把 20 放入操作数栈</span><br><span class="hljs-number">14</span>: istore_1 <span class="hljs-comment">//把 20 赋值给 a</span><br><span class="hljs-number">15</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-2-5-循环控制"><a href="#3-2-5-循环控制" class="headerlink" title="3.2.5 循环控制"></a>3.2.5 循环控制</h3><p>其实循环控制还是前面介绍的那些指令，例如 while 循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">10</span>) &#123;<br>        	a++;<br>        &#125;<br>    &#125;<br>&#125;<br><br>code:<br><span class="hljs-number">0</span>: iconst_0<br><span class="hljs-number">1</span>: istore_1<br><span class="hljs-number">2</span>: iload_1<br><span class="hljs-number">3</span>: bipush <span class="hljs-number">10</span><br><span class="hljs-number">5</span>: if_icmpge <span class="hljs-number">14</span><br><span class="hljs-number">8</span>: iinc <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br><span class="hljs-number">11</span>: goto <span class="hljs-number">2</span><br><span class="hljs-number">14</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>



<p>再比如 do while 循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            a++;<br>        &#125; <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">10</span>);<br>    &#125;<br>&#125;<br><br>code:<br><span class="hljs-number">0</span>: iconst_0<br><span class="hljs-number">1</span>: istore_1<br><span class="hljs-number">2</span>: iinc <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br><span class="hljs-number">5</span>: iload_1<br><span class="hljs-number">6</span>: bipush <span class="hljs-number">10</span><br><span class="hljs-number">8</span>: if_icmplt <span class="hljs-number">2</span><br><span class="hljs-number">11</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>



<p>最后再看看 for 循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-number">0</span>: iconst_0<br><span class="hljs-number">1</span>: istore_1<br><span class="hljs-number">2</span>: iload_1<br><span class="hljs-number">3</span>: bipush <span class="hljs-number">10</span><br><span class="hljs-number">5</span>: if_icmpge <span class="hljs-number">14</span><br><span class="hljs-number">8</span>: iinc <span class="hljs-number">1</span>, <span class="hljs-number">1</span><br><span class="hljs-number">11</span>: goto <span class="hljs-number">2</span><br><span class="hljs-number">14</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-2-6-练习-分析x-x3D-0（经典）"><a href="#3-2-6-练习-分析x-x3D-0（经典）" class="headerlink" title="3.2.6 练习-分析x&#x3D;0（经典）"></a>3.2.6 练习-分析x&#x3D;0（经典）</h3><p>请从字节码角度分析，下列代码运行的结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>		<span class="hljs-type">int</span> x=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span>(i&lt;<span class="hljs-number">10</span>) &#123;<br>			x = x++;<br>			i++;<br>		&#125;<br>		System.out.println(x); <span class="hljs-comment">//接过为0</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为什么最终的x结果为0呢？ 通过分析字节码指令即可知晓:</p>
<p>code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">0</span>: iconst_0	<span class="hljs-comment">//准备一个常数0</span><br><span class="hljs-number">1</span>: istore_1	<span class="hljs-comment">//将常数0放入局部变量表的1号槽位 i=0</span><br><span class="hljs-number">2</span>: iconst_0	<span class="hljs-comment">//准备一个常数0</span><br><span class="hljs-number">3</span>: istore_2	<span class="hljs-comment">//将常数0放入局部变量的2号槽位 x=0	</span><br><span class="hljs-number">4</span>: <br><span class="hljs-number">5</span>: bipush        <span class="hljs-number">10</span>	<span class="hljs-comment">//将数字10放入操作数栈中，此时操作数栈中有2个数</span><br><span class="hljs-number">7</span>: if_icmpge     <span class="hljs-number">21</span>	<span class="hljs-comment">//比较操作数栈中的两个数，如果下面的数大于上面的数，就跳转到21。这里的比较是将两个数做减法。因为涉及运算操作，所以会将两个数弹出操作数栈来进行运算。运算结束后操作数栈为空</span><br><span class="hljs-number">10</span>: iload_2		<span class="hljs-comment">//将局部变量2号槽位的数放入操作数栈中，放入的值是0</span><br><span class="hljs-number">11</span>: iinc          <span class="hljs-number">2</span>, <span class="hljs-number">1</span>	<span class="hljs-comment">//将局部变量2号槽位的数加1，自增后，槽位中的值为1</span><br><span class="hljs-number">14</span>: istore_2	<span class="hljs-comment">//将操作数栈中的数放入到局部变量表的2号槽位，2号槽位的值又变为了0</span><br><span class="hljs-number">15</span>: iinc          <span class="hljs-number">1</span>, <span class="hljs-number">1</span> <span class="hljs-comment">//1号槽位的值自增1</span><br><span class="hljs-number">18</span>: goto          <span class="hljs-number">4</span> <span class="hljs-comment">//跳转到第4条指令</span><br><span class="hljs-number">21</span>: getstatic     #<span class="hljs-number">2</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="hljs-number">24</span>: iload_2<br><span class="hljs-number">25</span>: invokevirtual #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Method java/io/PrintStream.println:(I)V</span><br><span class="hljs-number">28</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>

<p>简单图解分析（不包含对循环的判断，对循环的判断详情在上面的注释）</p>
<p>因为是循环嘛，就简单的解释下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">x = <span class="hljs-number">0</span>;<br>x = x++;<br><br>code:<br><span class="hljs-number">0</span>: iconst_0	<span class="hljs-comment">//准备一个常数0</span><br><span class="hljs-number">1</span>: istore_1	<span class="hljs-comment">//将常数0放入局部变量表的1号槽位 x=0</span><br><span class="hljs-number">2</span>: iload_1		<span class="hljs-comment">//将局部变量表1号槽位的数放入操作数栈中</span><br><span class="hljs-number">3</span>: iinc          <span class="hljs-number">1</span>, <span class="hljs-number">1</span>	<span class="hljs-comment">//将局部变量1号槽位的数加1，自增后，槽位中的值为1</span><br><span class="hljs-number">4</span>: istore_1	<span class="hljs-comment">//将操作数栈中的数放入到局部变量表的1号槽位，1号槽位的值又变为了0; 即赋值操作 x = ，赋值操作是赋值操作数栈里的，具体看3.2.2.4中</span><br></code></pre></td></tr></table></figure>

<p>图解：<a target="_blank" rel="noopener" href="https://www.processon.com/view/link/62f14dd41efad4106699d25a">分析x &#x3D; 0 | ProcessOn免费在线作图,在线流程图,在线思维导图 |</a></p>
<hr>
<h3 id="3-2-7-构造方法"><a href="#3-2-7-构造方法" class="headerlink" title="3.2.7 构造方法"></a>3.2.7 构造方法</h3><h4 id="3-2-7-1-cinit-V"><a href="#3-2-7-1-cinit-V" class="headerlink" title="3.2.7.1 cinit()V"></a>3.2.7.1 cinit()V</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3</span> &#123;<br>	<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br>	<span class="hljs-keyword">static</span> &#123;<br>		i = <span class="hljs-number">20</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">static</span> &#123;<br>		i = <span class="hljs-number">30</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		System.out.println(i); <span class="hljs-comment">//结果为30</span><br>	&#125;<br>&#125;Copy<br></code></pre></td></tr></table></figure>

<p>编译器会按<strong>从上至下</strong>的顺序，收集所有 static 静态代码块和静态成员赋值的代码，<strong>合并</strong>为一个特殊的方法 cinit()V ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">0</span>, args_size=<span class="hljs-number">0</span><br>         <span class="hljs-number">0</span>: bipush        <span class="hljs-number">10</span><br>         <span class="hljs-number">2</span>: putstatic     #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Field i:I 变量赋值</span><br>         <span class="hljs-number">5</span>: bipush        20ja<br>         <span class="hljs-number">7</span>: putstatic     #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Field i:I</span><br>        <span class="hljs-number">10</span>: bipush        <span class="hljs-number">30</span><br>        <span class="hljs-number">12</span>: putstatic     #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Field i:I</span><br>        <span class="hljs-number">15</span>: <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure>



<hr>
<h4 id="3-2-7-2-init-V"><a href="#3-2-7-2-init-V" class="headerlink" title="3.2.7.2 init()V"></a>3.2.7.2 init()V</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4</span> &#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;s1&quot;</span>;<br><br>	&#123;<br>		b = <span class="hljs-number">20</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br>	&#123;<br>		a = <span class="hljs-string">&quot;s2&quot;</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo4</span><span class="hljs-params">(String a, <span class="hljs-type">int</span> b)</span> &#123;<br>		<span class="hljs-built_in">this</span>.a = a;<br>		<span class="hljs-built_in">this</span>.b = b;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">Demo4</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo4</span>(<span class="hljs-string">&quot;s3&quot;</span>, <span class="hljs-number">30</span>);<br>		System.out.println(d.a);<br>		System.out.println(d.b);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>编译器会按<strong>从上至下</strong>的顺序，收集所有 {} 代码块和成员变量赋值的代码，<strong>形成新的构造方法</strong>，但<strong>原始构造方法</strong>内的代码<strong>总是在后</strong></li>
<li>如果有多个构造函数，则会一一对应生成多个<init></li>
<li>简单说：执行顺序：静态代码块 &gt; 代码块 &gt; 构造方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> cn.itcast.jvm.t3.bytecode.Demo3_8_2(java.lang.String, <span class="hljs-type">int</span>);<br>    descriptor: (Ljava/lang/String;I)V<br>    flags: ACC_PUBLIC<br>    Code:<br>        stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">3</span><br>        <span class="hljs-number">0</span>: aload_0<br>        <span class="hljs-number">1</span>: invokespecial #<span class="hljs-number">1</span> <span class="hljs-comment">// super.&lt;init&gt;()V</span><br>        <span class="hljs-number">4</span>: aload_0<br>        <span class="hljs-number">5</span>: ldc #<span class="hljs-number">2</span> <span class="hljs-comment">// &lt;- &quot;s1&quot;</span><br>        <span class="hljs-number">7</span>: putfield #<span class="hljs-number">3</span> <span class="hljs-comment">// -&gt; this.a</span><br>        <span class="hljs-number">10</span>: aload_0<br>        <span class="hljs-number">11</span>: bipush <span class="hljs-number">20</span> <span class="hljs-comment">// &lt;- 20</span><br>        <span class="hljs-number">13</span>: putfield #<span class="hljs-number">4</span> <span class="hljs-comment">// -&gt; this.b</span><br>        <span class="hljs-number">16</span>: aload_0<br>        <span class="hljs-number">17</span>: bipush <span class="hljs-number">10</span> <span class="hljs-comment">// &lt;- 10</span><br>        <span class="hljs-number">19</span>: putfield #<span class="hljs-number">4</span> <span class="hljs-comment">// -&gt; this.b</span><br>        <span class="hljs-number">22</span>: aload_0<br>        <span class="hljs-number">23</span>: ldc #<span class="hljs-number">5</span> <span class="hljs-comment">// &lt;- &quot;s2&quot;</span><br>        <span class="hljs-number">25</span>: putfield #<span class="hljs-number">3</span> <span class="hljs-comment">// -&gt; this.a</span><br>        <span class="hljs-number">28</span>: aload_0 <span class="hljs-comment">// ------------------------------</span><br>        <span class="hljs-number">29</span>: aload_1 <span class="hljs-comment">// &lt;- slot 1(a) &quot;s3&quot; |</span><br>        <span class="hljs-number">30</span>: putfield #<span class="hljs-number">3</span> <span class="hljs-comment">// -&gt; this.a |</span><br>        <span class="hljs-number">33</span>: aload_0 |<br>        <span class="hljs-number">34</span>: iload_2 <span class="hljs-comment">// &lt;- slot 2(b) 30 |</span><br>        <span class="hljs-number">35</span>: putfield #<span class="hljs-number">4</span> <span class="hljs-comment">// -&gt; this.b --------------------</span><br>        <span class="hljs-number">38</span>: <span class="hljs-keyword">return</span><br>    LineNumberTable: ...<br>    LocalVariableTable:<br>    Start Length Slot Name Signature<br>    <span class="hljs-number">0</span> <span class="hljs-number">39</span> <span class="hljs-number">0</span> <span class="hljs-built_in">this</span> Lcn/itcast/jvm/t3/bytecode/Demo3_8_2;<br>    <span class="hljs-number">0</span> <span class="hljs-number">39</span> <span class="hljs-number">1</span> a Ljava/lang/String;<br>    <span class="hljs-number">0</span> <span class="hljs-number">39</span> <span class="hljs-number">2</span> b I<br>    MethodParameters: ...<br><br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-2-8-方法调用"><a href="#3-2-8-方法调用" class="headerlink" title="3.2.8 方法调用"></a>3.2.8 方法调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo5</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo5</span><span class="hljs-params">()</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> &#123;<br><br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">Demo5</span> <span class="hljs-variable">demo5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo5</span>();<br>		demo5.test1();<br>		demo5.test2();<br>		demo5.test3();<br>		Demo5.test4();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不同方法在调用时，对应的虚拟机指令有所区别</p>
<ul>
<li>私有、构造、被final修饰的方法，在调用时都使用<strong>invokespecial</strong>指令</li>
<li>普通成员方法在调用时，使用invokespecial指令。因为编译期间无法确定该方法的内容，只有在运行期间才能确定</li>
<li>静态方法在调用时使用invokestatic指令</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Code:</span><br>      <span class="hljs-string">stack=2,</span> <span class="hljs-string">locals=2,</span> <span class="hljs-string">args_size=1</span><br>         <span class="hljs-attr">0:</span> <span class="hljs-string">new</span>           <span class="hljs-comment">#2                  // class com/Demo5 </span><br>         <span class="hljs-attr">3:</span> <span class="hljs-string">dup</span><br>         <span class="hljs-attr">4:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#3                  // Method &quot;&lt;init&gt;&quot;:()V</span><br>         <span class="hljs-attr">7:</span> <span class="hljs-string">astore_1</span><br>         <span class="hljs-attr">8:</span> <span class="hljs-string">aload_1</span><br>         <span class="hljs-attr">9:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#4                  // Method test1:()V</span><br>        <span class="hljs-attr">12:</span> <span class="hljs-string">aload_1</span><br>        <span class="hljs-attr">13:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#5                  // Method test2:()V</span><br>        <span class="hljs-attr">16:</span> <span class="hljs-string">aload_1</span><br>        <span class="hljs-attr">17:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#6                  // Method test3:()V</span><br>        <span class="hljs-attr">20:</span> <span class="hljs-string">invokestatic</span>  <span class="hljs-comment">#7                  // Method test4:()V</span><br>        <span class="hljs-attr">23:</span> <span class="hljs-string">returnCopy</span><br></code></pre></td></tr></table></figure>

<ul>
<li>new 是创建【对象】，给对象分配堆内存，执行成功会将【<strong>对象引用</strong>】压入操作数栈</li>
<li>dup 是赋值操作数栈栈顶的内容，本例即为【<strong>对象引用</strong>】，为什么需要两份引用呢，一个是要配合 invokespecial 调用该对象的构造方法 “init”:()V （会消耗掉栈顶一个引用），另一个要 配合 astore_1 赋值给局部变量</li>
<li>终方法（ﬁnal），私有方法（private），构造方法都是由 invokespecial 指令来调用，属于静态绑定</li>
<li>普通成员方法是由 invokevirtual 调用，属于<strong>动态绑定</strong>，即支持多态 成员方法与静态方法调用的另一个区别是，执行方法前是否需要【对象引用】</li>
</ul>
<hr>
<h3 id="3-2-9-多态的原理"><a href="#3-2-9-多态的原理" class="headerlink" title="3.2.9 多态的原理"></a>3.2.9 多态的原理</h3><blockquote>
<p>ps: 实在不理解，仅摘抄笔记 <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP?p=122">https://www.bilibili.com/video/BV1yE411Z7AP?p=122</a></p>
</blockquote>
<p>因为普通成员方法需要在运行时才能确定具体的内容，所以虚拟机需要调用<strong>invokevirtual</strong>指令</p>
<p>在执行invokevirtual指令时，经历了以下几个步骤</p>
<ul>
<li>先通过栈帧中对象的引用找到对象</li>
<li><strong>分析对象头</strong>，找到对象实际的Class</li>
<li>Class结构中有<strong>vtable</strong>，它在类加载的链接阶段就已经根据方法的重写规则生成好了</li>
<li>查询vtable找到方法的具体地址</li>
<li>执行方法的字节码</li>
</ul>
<hr>
<h3 id="3-2-10-异常处理-面试问"><a href="#3-2-10-异常处理-面试问" class="headerlink" title="3.2.10 异常处理(面试问)"></a>3.2.10 异常处理(面试问)</h3><h4 id="3-2-10-1-try-catch"><a href="#3-2-10-1-try-catch" class="headerlink" title="3.2.10.1 try-catch"></a>3.2.10.1 try-catch</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *代码</span><br><span class="hljs-comment">**/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>        	i = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        	i = <span class="hljs-number">20</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;<br>    descriptor: ([Ljava/lang/String;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>        stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br>            <span class="hljs-number">0</span>: iconst_0<br>            <span class="hljs-number">1</span>: istore_1<br>            <span class="hljs-number">2</span>: bipush <span class="hljs-number">10</span><br>            <span class="hljs-number">4</span>: istore_1<br>            <span class="hljs-number">5</span>: goto <span class="hljs-number">12</span><br>            <span class="hljs-number">8</span>: astore_2<br>            <span class="hljs-number">9</span>: bipush <span class="hljs-number">20</span><br>            <span class="hljs-number">11</span>: istore_1<br>            <span class="hljs-number">12</span>: <span class="hljs-keyword">return</span><br>        Exception table: <span class="hljs-comment">//异常表，用来监测</span><br>        from    to target    type<br>            <span class="hljs-number">2</span>    <span class="hljs-number">5</span>      <span class="hljs-number">8</span>    Class java/lang/Exception<br>        LineNumberTable: ...<br>        LocalVariableTable:<br>        Start Length Slot Name Signature<br>            <span class="hljs-number">9</span>      <span class="hljs-number">3</span>    <span class="hljs-number">2</span>    e   Ljava/lang/Exception;<br>            <span class="hljs-number">0</span>     <span class="hljs-number">13</span>    <span class="hljs-number">0</span>   args [Ljava/lang/String;<br>            <span class="hljs-number">2</span>     <span class="hljs-number">11</span>    <span class="hljs-number">1</span>     i   I<br>        StackMapTable: ...<br>    MethodParameters: ...<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>可以看到多出来一个 Exception table 的结构，[from, to) 是<strong>前闭后开</strong>（也就是检测2~4行）的检测范围，一旦这个范围内的字节码执行出现异常，则通过 <strong>type 匹配</strong>异常类型，如果一致，进入 target 所指示行号</li>
<li>8行的字节码指令 astore_2 是将异常对象引用存入局部变量表的2号位置（为e）</li>
</ul>
<hr>
<h4 id="3-2-10-2-多个single-catch"><a href="#3-2-10-2-多个single-catch" class="headerlink" title="3.2.10.2 多个single-catch"></a>3.2.10.2 多个single-catch</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>        	i = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (ArithmeticException e) &#123;<br>        	i = <span class="hljs-number">30</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (NullPointerException e) &#123;<br>        	i = <span class="hljs-number">40</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        	i = <span class="hljs-number">50</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">public static void main(java.lang.String[]);</span><br><span class="hljs-attribute">    descriptor</span><span class="hljs-punctuation">:</span> <span class="hljs-string">([Ljava/lang/String;)V</span><br>    <span class="hljs-attribute">flags</span><span class="hljs-punctuation">:</span> <span class="hljs-string">ACC_PUBLIC, ACC_STATIC</span><br>    <span class="hljs-attribute">Code</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-attribute">stack=1, locals=3, args_size=1</span><br><span class="hljs-attribute">            0</span><span class="hljs-punctuation">:</span> <span class="hljs-string">iconst_0</span><br>            <span class="hljs-attribute">1</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>            <span class="hljs-attribute">2</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 10</span><br>            <span class="hljs-attribute">4</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>            <span class="hljs-attribute">5</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goto 26</span><br>            <span class="hljs-attribute">8</span><span class="hljs-punctuation">:</span> <span class="hljs-string">astore_2</span><br>            <span class="hljs-attribute">9</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 30</span><br>            <span class="hljs-attribute">11</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>            <span class="hljs-attribute">12</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goto 26</span><br>            <span class="hljs-attribute">15</span><span class="hljs-punctuation">:</span> <span class="hljs-string">astore_2</span><br>            <span class="hljs-attribute">16</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 40</span><br>            <span class="hljs-attribute">18</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>            <span class="hljs-attribute">19</span><span class="hljs-punctuation">:</span> <span class="hljs-string">goto 26</span><br>            <span class="hljs-attribute">22</span><span class="hljs-punctuation">:</span> <span class="hljs-string">astore_2</span><br>            <span class="hljs-attribute">23</span><span class="hljs-punctuation">:</span> <span class="hljs-string">bipush 50</span><br>            <span class="hljs-attribute">25</span><span class="hljs-punctuation">:</span> <span class="hljs-string">istore_1</span><br>            <span class="hljs-attribute">26</span><span class="hljs-punctuation">:</span> <span class="hljs-string">return</span><br>        <span class="hljs-attribute">Exception table</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-attribute">from   to   target   type</span><br><span class="hljs-attribute">           2    5       8    Class java/lang/ArithmeticException</span><br><span class="hljs-attribute">           2    5       15   Class java/lang/NullPointerException</span><br><span class="hljs-attribute">           2    5       22   Class java/lang/Exception</span><br><span class="hljs-attribute">        LineNumberTable</span><span class="hljs-punctuation">:</span> <span class="hljs-string">...</span><br>        <span class="hljs-attribute">LocalVariableTable</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-attribute">Start    Length    Slot    Name    Signature</span><br><span class="hljs-attribute">            9         3       2       e    Ljava/lang/ArithmeticException;</span><br><span class="hljs-attribute">           16         3       2       e    Ljava/lang/NullPointerException;</span><br><span class="hljs-attribute">           23         3       2       e    Ljava/lang/Exception;</span><br><span class="hljs-attribute">            0        27       0      args  [Ljava/lang/String;</span><br><span class="hljs-attribute">            2         25      1      i     I</span><br><span class="hljs-attribute">        StackMapTable</span><span class="hljs-punctuation">:</span> <span class="hljs-string">...</span><br>    <span class="hljs-attribute">MethodParameters</span><span class="hljs-punctuation">:</span> <span class="hljs-string">...</span><br></code></pre></td></tr></table></figure>

<ul>
<li>因为异常出现时，<strong>只能进入</strong> Exception table 中<strong>一个分支</strong>，所以局部变量表 slot 2 位置<strong>被共用</strong></li>
</ul>
<hr>
<h4 id="3-2-10-3-multi-chtch的情况"><a href="#3-2-10-3-multi-chtch的情况" class="headerlink" title="3.2.10.3 multi-chtch的情况"></a>3.2.10.3 multi-chtch的情况</h4><ul>
<li>相当于多个single-catch的优化，把平级的异常写在一起</li>
<li>target都一样</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>        	<span class="hljs-type">Method</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> Demo3_11_3.class.getMethod(<span class="hljs-string">&quot;test&quot;</span>);<br>        	test.invoke(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException | IllegalAccessException |<br>        	InvocationTargetException e) &#123;<br>        	e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;ok&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<h4 id="3-2-10-4-finally"><a href="#3-2-10-4-finally" class="headerlink" title="3.2.10.4 finally"></a>3.2.10.4 finally</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3_11_4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>        	i = <span class="hljs-number">10</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        	i = <span class="hljs-number">20</span>;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>        	i = <span class="hljs-number">30</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(java.lang.String[])</span>;<br>    descriptor: ([Ljava/lang/String;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>        stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">4</span>, args_size=<span class="hljs-number">1</span><br>            <span class="hljs-number">0</span>: iconst_0<br>            <span class="hljs-number">1</span>: istore_1   <span class="hljs-comment">// 0 -&gt; i</span><br>            <span class="hljs-comment">/**try块**/</span><br>            <span class="hljs-number">2</span>: bipush <span class="hljs-number">10</span>  <span class="hljs-comment">// try --------------------------------------</span><br>            <span class="hljs-number">4</span>: istore_1   <span class="hljs-comment">// 10 -&gt; i                                  |</span><br>            <span class="hljs-comment">/**try块执行完后，会执行finally**/</span>                           |<br>            <span class="hljs-number">5</span>: bipush <span class="hljs-number">30</span>  <span class="hljs-comment">// finally                                  |</span><br>            <span class="hljs-number">7</span>: istore_1   <span class="hljs-comment">// 30 -&gt; i                                  |</span><br>            <span class="hljs-number">8</span>: goto <span class="hljs-number">27</span>    <span class="hljs-comment">// return -----------------------------------</span><br>            <span class="hljs-comment">/**catch块**/</span>      <br>            <span class="hljs-number">11</span>: astore_2  <span class="hljs-comment">// catch Exceptin -&gt; e 异常信息放入局部变量表的2号槽位</span><br>            <span class="hljs-number">12</span>: bipush <span class="hljs-number">20</span> <span class="hljs-comment">//         								  |</span><br>            <span class="hljs-number">14</span>: istore_1  <span class="hljs-comment">// 20 -&gt; i 								  |</span><br>            <span class="hljs-comment">/**catch块执行完后，会执行finally**/</span>                         |<br>            <span class="hljs-number">15</span>: bipush <span class="hljs-number">30</span> <span class="hljs-comment">// finally 								  |</span><br>            <span class="hljs-number">17</span>: istore_1  <span class="hljs-comment">// 30 -&gt; i 								  |</span><br>            <span class="hljs-number">18</span>: goto <span class="hljs-number">27</span>   <span class="hljs-comment">// return -----------------------------------</span><br>            <span class="hljs-comment">/**出现异常，但未被Exception捕获，会抛出其他异常，这时也需要执行finally块中的代码**/</span>   <br>            <span class="hljs-number">21</span>: astore_3  <span class="hljs-comment">// catch any -&gt; slot 3 ----------------------</span><br>            <span class="hljs-number">22</span>: bipush <span class="hljs-number">30</span> <span class="hljs-comment">// finally                                  |</span><br>            <span class="hljs-comment">/**同上**/</span><br>            <span class="hljs-number">24</span>: istore_1  <span class="hljs-comment">// 30 -&gt; i                                  |</span><br>            <span class="hljs-number">25</span>: aload_3   <span class="hljs-comment">// &lt;- slot 3                                |</span><br>            <span class="hljs-number">26</span>: athrow    <span class="hljs-comment">// throw 抛出异常-----------------------------</span><br>            <span class="hljs-number">27</span>: <span class="hljs-keyword">return</span><br>        Exception table:<br>            from to target type<br>            <span class="hljs-number">2</span>    <span class="hljs-number">5</span>   <span class="hljs-number">11</span>    Class java/lang/Exception<br>            <span class="hljs-number">2</span>    <span class="hljs-number">5</span>   <span class="hljs-number">21</span>    any <span class="hljs-comment">// 剩余的异常类型，比如 Error</span><br>            <span class="hljs-number">11</span>   <span class="hljs-number">15</span>  <span class="hljs-number">21</span>    any <span class="hljs-comment">// 剩余的异常类型，比如 Error</span><br>        LineNumberTable: ...<br>        LocalVariableTable:<br>            Start Length Slot Name  Signature<br>            <span class="hljs-number">12</span>    <span class="hljs-number">3</span>      <span class="hljs-number">2</span>     e     Ljava/lang/Exception;<br>            <span class="hljs-number">0</span>     <span class="hljs-number">28</span>     <span class="hljs-number">0</span>     args [Ljava/lang/String;<br>            <span class="hljs-number">2</span>     <span class="hljs-number">26</span>     <span class="hljs-number">1</span>     i     I<br>        StackMapTable: ...<br>    MethodParameters: ...<br><br></code></pre></td></tr></table></figure>

<ul>
<li>可以看到 ﬁnally 中的代码被<strong>复制了 3 份</strong>，分别放入 try 流程，catch 流程以及 catch剩余的异常类型流程</li>
<li><strong>注意</strong>：虽然从字节码指令看来，每个块中都有finally块，但是finally块中的代码<strong>只会被执行一次</strong></li>
</ul>
<hr>
<h4 id="3-2-10-5-finally面试题"><a href="#3-2-10-5-finally面试题" class="headerlink" title="3.2.10.5 finally面试题"></a>3.2.10.5 finally面试题</h4><h5 id="题一：finally中含有return"><a href="#题一：finally中含有return" class="headerlink" title="题一：finally中含有return"></a>题一：finally中含有return</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Demo3.test();<br>		System.out.println(i);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-type">int</span> i;<br>		<span class="hljs-keyword">try</span> &#123;<br>			i = <span class="hljs-number">10</span>;<br>			<span class="hljs-keyword">return</span> i;<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			i = <span class="hljs-number">20</span>;<br>			<span class="hljs-keyword">return</span> i;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span>;<br>    descriptor: ()I<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>        stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">2</span>, args_size=<span class="hljs-number">0</span><br>            <span class="hljs-number">0</span>: bipush <span class="hljs-number">10</span> <span class="hljs-comment">// &lt;- 10 放入栈顶</span><br>            <span class="hljs-number">2</span>: istore_0 <span class="hljs-comment">// 10 -&gt; slot 0 (从栈顶移除了)</span><br>            <span class="hljs-number">3</span>: bipush <span class="hljs-number">20</span> <span class="hljs-comment">// &lt;- 20 放入栈顶</span><br>            <span class="hljs-number">5</span>: ireturn <span class="hljs-comment">// 返回栈顶 int(20)</span><br>            <span class="hljs-number">6</span>: astore_1 <span class="hljs-comment">// catch any -&gt; slot 1</span><br>            <span class="hljs-number">7</span>: bipush <span class="hljs-number">20</span> <span class="hljs-comment">// &lt;- 20 放入栈顶</span><br>            <span class="hljs-number">9</span>: ireturn <span class="hljs-comment">// 返回栈顶 int(20)</span><br>        Exception table:<br>            from to target type<br>               <span class="hljs-number">0</span>  <span class="hljs-number">3</span>     <span class="hljs-number">6</span>   any<br>        LineNumberTable: ...<br>        StackMapTable: ...<br></code></pre></td></tr></table></figure>

<p><strong>所以结果为20</strong></p>
<ul>
<li><p>由于 ﬁnally 中的 <strong>ireturn</strong> 被插入了所有可能的流程，因此返回结果肯定以ﬁnally的为准</p>
</li>
<li><p>至于字节码中第 2 行，似乎没啥用，且留个伏笔，看下个例子</p>
<ul>
<li><p>实际上呢是istore_0后面还有iload_0、和istore_1 用来暂存返回值；</p>
</li>
<li><p>这个时候临时变量表0号位和1号位都是 10，操作数栈为空</p>
</li>
<li><p>然后执行finally，bipush 20后面起始还有，istore_0，iload_0</p>
</li>
<li><p>这个时候呢临时变量表0号位是 10，局部<strong>变量表栈顶是20</strong></p>
</li>
<li><p>最后ireturn 20</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java">完整code <br> <span class="hljs-number">0</span>: bipush        <span class="hljs-number">10</span><br> <span class="hljs-number">2</span>: istore_0<br> <span class="hljs-number">3</span>: iload_0<br> <span class="hljs-number">4</span>: istore_1  <span class="hljs-comment">//暂存返回值</span><br> <span class="hljs-number">5</span>: bipush        <span class="hljs-number">20</span><br> <span class="hljs-number">7</span>: istore_0<br> <span class="hljs-number">8</span>: iload_0<br> <span class="hljs-number">9</span>: ireturn	<span class="hljs-comment">//ireturn会返回操作数栈顶的整型值20</span><br><span class="hljs-comment">//如果出现异常，还是会执行finally块中的内容，没有抛出异常</span><br><span class="hljs-number">10</span>: astore_2<br><span class="hljs-number">11</span>: bipush        <span class="hljs-number">20</span><br><span class="hljs-number">13</span>: istore_0<br><span class="hljs-number">14</span>: iload_0<br><span class="hljs-number">15</span>: ireturn	<span class="hljs-comment">//这里没有athrow了，也就是如果在finally块中如果有返回操作的话，且try块中出现异常，会吞掉异常！</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>跟上例中的 ﬁnally 相比，发现<strong>没有 athrow 了</strong>，这告诉我们：如果在 ﬁnally 中出现了 return，会<strong>吞掉异常</strong></p>
</li>
<li><p>所以<strong>不要在finally中进行返回操作</strong></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Demo3.test();<br>      <span class="hljs-comment">//最终结果为20</span><br>      System.out.println(i);<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-type">int</span> i;<br>      <span class="hljs-keyword">try</span> &#123;<br>         i = <span class="hljs-number">10</span>;<br>         <span class="hljs-comment">//这里应该会抛出异常</span><br>         i = i/<span class="hljs-number">0</span>;<br>         <span class="hljs-keyword">return</span> i;<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>         i = <span class="hljs-number">20</span>;<br>         <span class="hljs-keyword">return</span> i;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会发现打印结果为20，并未抛出异常</p>
<hr>
<h5 id="题二：finally中不含有return"><a href="#题二：finally中不含有return" class="headerlink" title="题二：finally中不含有return"></a>题二：finally中不含有return</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Demo4.test();<br>		System.out.println(i);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-keyword">return</span> i;<br>		&#125; <span class="hljs-keyword">finally</span> &#123;<br>			i = <span class="hljs-number">20</span>;<br>		&#125;<br>	&#125;<br>&#125;Copy<br></code></pre></td></tr></table></figure>

<p>对应字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java">Code:<br>     stack=<span class="hljs-number">1</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">0</span><br>        <span class="hljs-number">0</span>: bipush        <span class="hljs-number">10</span><br>        <span class="hljs-number">2</span>: istore_0 <span class="hljs-comment">//赋值给i 10</span><br>        <span class="hljs-number">3</span>: iload_0	<span class="hljs-comment">//加载到操作数栈顶</span><br>        <span class="hljs-number">4</span>: istore_1 <span class="hljs-comment">//加载到局部变量表的1号位置</span><br>        <span class="hljs-number">5</span>: bipush        <span class="hljs-number">20</span><br>        <span class="hljs-number">7</span>: istore_0 <span class="hljs-comment">//赋值给i 20</span><br>        <span class="hljs-number">8</span>: iload_1 <span class="hljs-comment">//加载局部变量表1号位置的数10到操作数栈</span><br>        <span class="hljs-number">9</span>: ireturn <span class="hljs-comment">//返回操作数栈顶元素 10</span><br>       <span class="hljs-number">10</span>: astore_2<br>       <span class="hljs-number">11</span>: bipush        <span class="hljs-number">20</span><br>       <span class="hljs-number">13</span>: istore_0<br>       <span class="hljs-number">14</span>: aload_2 <span class="hljs-comment">//加载异常</span><br>       <span class="hljs-number">15</span>: athrow <span class="hljs-comment">//抛出异常</span><br>     Exception table:<br>        from    to  target type<br>            <span class="hljs-number">3</span>     <span class="hljs-number">5</span>    <span class="hljs-number">10</span>   any<br></code></pre></td></tr></table></figure>

<p>即上道题中卖的关子，也解释了；第3，4行的意图就是在1号位上保存好这个return，因为后面还有finally的代码要执行</p>
<p>答案为10</p>
<hr>
<h3 id="3-2-11-synchronized"><a href="#3-2-11-synchronized" class="headerlink" title="3.2.11 synchronized"></a>3.2.11 synchronized</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo5</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>		<span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Lock</span>();<br>		<span class="hljs-keyword">synchronized</span> (lock) &#123;<br>			System.out.println(i);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Lock</span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>对应字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java">Code:<br>     stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">5</span>, args_size=<span class="hljs-number">1</span><br>        <span class="hljs-number">0</span>: bipush        <span class="hljs-number">10</span><br>        <span class="hljs-number">2</span>: istore_1<br>        <span class="hljs-number">3</span>: <span class="hljs-keyword">new</span>           #<span class="hljs-number">2</span>                  <span class="hljs-comment">// class com/nyima/JVM/day06/Lock</span><br>        <span class="hljs-number">6</span>: dup <span class="hljs-comment">//复制一份，放到操作数栈顶，用于构造函数消耗</span><br>        <span class="hljs-number">7</span>: invokespecial #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Method com/nyima/JVM/day06/Lock.&quot;&lt;init&gt;&quot;:()V</span><br>       <span class="hljs-number">10</span>: astore_2 <span class="hljs-comment">//剩下的一份放到局部变量表的2号位置</span><br>       <span class="hljs-number">11</span>: aload_2 <span class="hljs-comment">//加载到操作数栈</span><br>       <span class="hljs-number">12</span>: dup <span class="hljs-comment">//复制一份，放到操作数栈，用于加锁时消耗</span><br>       <span class="hljs-number">13</span>: astore_3 <span class="hljs-comment">//将操作数栈顶元素弹出，暂存到局部变量表的三号槽位。这时操作数栈中有一份对象的引用</span><br>       <span class="hljs-number">14</span>: monitorenter <span class="hljs-comment">//加锁</span><br>       <span class="hljs-comment">//锁住后代码块中的操作    </span><br>       <span class="hljs-number">15</span>: getstatic     #<span class="hljs-number">4</span>                  <span class="hljs-comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span><br>       <span class="hljs-number">18</span>: iload_1<br>       <span class="hljs-number">19</span>: invokevirtual #<span class="hljs-number">5</span>                  <span class="hljs-comment">// Method java/io/PrintStream.println:(I)V</span><br>       <span class="hljs-comment">//加载局部变量表中三号槽位对象的引用，用于解锁    </span><br>       <span class="hljs-number">22</span>: aload_3    <br>       <span class="hljs-number">23</span>: monitorexit <span class="hljs-comment">//解锁</span><br>       <span class="hljs-number">24</span>: goto          <span class="hljs-number">34</span><br>       <span class="hljs-comment">//异常操作    </span><br>       <span class="hljs-number">27</span>: astore        <span class="hljs-number">4</span><br>       <span class="hljs-number">29</span>: aload_3<br>       <span class="hljs-number">30</span>: monitorexit <span class="hljs-comment">//解锁</span><br>       <span class="hljs-number">31</span>: aload         <span class="hljs-number">4</span><br>       <span class="hljs-number">33</span>: athrow<br>       <span class="hljs-number">34</span>: <span class="hljs-keyword">return</span><br>     <span class="hljs-comment">//可以看出，无论何时出现异常，都会跳转到27行，将异常放入局部变量中，并进行解锁操作，然后加载异常并抛出异常。      </span><br>     Exception table:<br>        from    to  target type<br>           <span class="hljs-number">15</span>    <span class="hljs-number">24</span>    <span class="hljs-number">27</span>   any<br>           <span class="hljs-number">27</span>    <span class="hljs-number">31</span>    <span class="hljs-number">27</span>   any<br></code></pre></td></tr></table></figure>



<hr>
<h2 id="3-3-编译期处理"><a href="#3-3-编译期处理" class="headerlink" title="3.3 编译期处理"></a>3.3 编译期处理</h2><p>所谓的 <strong>语法糖</strong> ，其实就是指 java 编译器把 *.java 源码编译为 *.class 字节码的过程中，<strong>自动生成</strong>和<strong>转换</strong>的一些代码，主要是为了减轻程序员的负担，算是 java 编译器给我们的一个额外福利</p>
<p><strong>注意</strong>，以下代码的分析，借助了 javap 工具，idea 的反编译功能，idea 插件 jclasslib 等工具。另外， 编译器转换的<strong>结果直接就是 class 字节码</strong>，只是为了便于阅读，给出了 几乎等价 的 java 源码方式，并不是编译器还会转换出中间的 java 源码，切记。</p>
<blockquote>
<p>引用了大佬的笔记：</p>
<p><a target="_blank" rel="noopener" href="https://nyimac.gitee.io/2020/07/03/JVM%E5%AD%A6%E4%B9%A0/">https://nyimac.gitee.io/2020/07/03/JVM%E5%AD%A6%E4%B9%A0/</a></p>
</blockquote>
<h3 id="3-3-1-默认构造函数"><a href="#3-3-1-默认构造函数" class="headerlink" title="3.3.1 默认构造函数"></a>3.3.1 默认构造函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy1</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>经过编译期优化后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy1</span> &#123;<br>   <span class="hljs-comment">//这个无参构造器是java编译器帮我们加上的</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy1</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">//即调用父类 Object 的无参构造方法，即调用 java/lang/Object.&quot; &lt;init&gt;&quot;:()V</span><br>      <span class="hljs-built_in">super</span>();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-3-2-自动拆装箱"><a href="#3-3-2-自动拆装箱" class="headerlink" title="3.3.2 自动拆装箱"></a>3.3.2 自动拆装箱</h3><p>基本类型和其包装类型的相互转换过程，称为拆装箱</p>
<p>在JDK 5以后，它们的转换可以在编译期自动完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> x;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>转换过程如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo2</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-comment">//基本类型赋值给包装类型，称为装箱</span><br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> Integer.valueOf(<span class="hljs-number">1</span>);<br>      <span class="hljs-comment">//包装类型赋值给基本类型，称谓拆箱</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> x.intValue();<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-3-3-泛型集合取值"><a href="#3-3-3-泛型集合取值" class="headerlink" title="3.3.3 泛型集合取值"></a>3.3.3 泛型集合取值</h3><p>泛型也是在 JDK 5 开始加入的特性，但 java 在<strong>编译泛型代码后</strong>会执行 <strong>泛型擦除</strong> 的动作，即泛型信息在编译为字节码之后就<strong>丢失</strong>了，实际的类型都当做了 <strong>Object</strong> 类型来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo3</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>      list.add(<span class="hljs-number">10</span>);<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> list.get(<span class="hljs-number">0</span>);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对应字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java">Code:<br>    stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br>       <span class="hljs-number">0</span>: <span class="hljs-keyword">new</span>           #<span class="hljs-number">2</span>                  <span class="hljs-comment">// class java/util/ArrayList</span><br>       <span class="hljs-number">3</span>: dup<br>       <span class="hljs-number">4</span>: invokespecial #<span class="hljs-number">3</span>                  <span class="hljs-comment">// Method java/util/ArrayList.&quot;&lt;init&gt;&quot;:()V</span><br>       <span class="hljs-number">7</span>: astore_1<br>       <span class="hljs-number">8</span>: aload_1<br>       <span class="hljs-number">9</span>: bipush        <span class="hljs-number">10</span><br>      <span class="hljs-number">11</span>: invokestatic  #<span class="hljs-number">4</span>                  <span class="hljs-comment">// Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br>      <span class="hljs-comment">//这里进行了泛型擦除，实际调用的是add(Objcet o)</span><br>      <span class="hljs-number">14</span>: invokeinterface #<span class="hljs-number">5</span>,  <span class="hljs-number">2</span>            <span class="hljs-comment">// InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z</span><br><br>      <span class="hljs-number">19</span>: pop<br>      <span class="hljs-number">20</span>: aload_1<br>      <span class="hljs-number">21</span>: iconst_0<br>      <span class="hljs-comment">//这里也进行了泛型擦除，实际调用的是get(Object o)   </span><br>      <span class="hljs-number">22</span>: invokeinterface #<span class="hljs-number">6</span>,  <span class="hljs-number">2</span>            <span class="hljs-comment">// InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;</span><br><span class="hljs-comment">//这里进行了类型转换，将Object转换成了Integer</span><br>      <span class="hljs-number">27</span>: checkcast     #<span class="hljs-number">7</span>                  <span class="hljs-comment">// class java/lang/Integer</span><br>      <span class="hljs-number">30</span>: astore_2<br>      <span class="hljs-number">31</span>: returnCopy<br></code></pre></td></tr></table></figure>

<p>所以调用get函数取值时，有一个类型转换的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (Integer) list.get(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<p>如果要将返回结果赋值给一个int类型的变量，则还有<strong>自动拆箱</strong>的操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> (Integer) list.get(<span class="hljs-number">0</span>).intValue();<br></code></pre></td></tr></table></figure>

<p>还好这些麻烦事都不用自己做。</p>
<hr>
<h3 id="3-3-4-可变参数"><a href="#3-3-4-可变参数" class="headerlink" title="3.3.4 可变参数"></a>3.3.4 可变参数</h3><p>可变参数也是 JDK 5 开始加入的新特性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(String... args)</span> &#123;<br>      <span class="hljs-comment">//将args赋值给arr，可以看出String...实际就是String[] </span><br>      String[] arr = args;<br>      System.out.println(arr.length);<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      foo(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可变参数 <strong>String…</strong> args 其实是一个 <strong>String[]</strong> args ，从代码中的赋值语句中就可以看出来。 同 样 java 编译器会在编译期间将上述代码变换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo4</span> &#123;<br>   <span class="hljs-keyword">public</span> Demo4 &#123;&#125;<br><br>    <br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">foo</span><span class="hljs-params">(String[] args)</span> &#123;<br>      String[] arr = args;<br>      System.out.println(arr.length);<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      foo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>&#125;);<br>   &#125;<br>&#125;Copy<br></code></pre></td></tr></table></figure>

<p>注意，如果调用的是foo()，即未传递参数时，等价代码为foo(new String[]{})，<strong>创建了一个空数组</strong>，而不是直接传递的null</p>
<hr>
<h3 id="3-3-5-foreach"><a href="#3-3-5-foreach" class="headerlink" title="3.3.5 foreach"></a>3.3.5 foreach</h3><p>仍是 JDK 5 开始引入的语法糖，数组的循环：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo5</span> &#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//数组赋初值的简化写法也是一种语法糖。</span><br>		<span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> x : arr) &#123;<br>			System.out.println(x);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译器会帮我们转换为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo5</span> &#123;<br>    <span class="hljs-keyword">public</span> Demo5 &#123;&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>		<span class="hljs-type">int</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;arr.length; ++i) &#123;<br>			<span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> arr[i];<br>			System.out.println(x);<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>如果是集合使用foreach</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo5</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);<br>      <span class="hljs-keyword">for</span> (Integer x : list) &#123;<br>         System.out.println(x);<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>集合要使用foreach，需要该集合类实现了<strong>Iterable接口</strong>，因为集合的遍历需要用到<strong>迭代器Iterator</strong>，实际被编译器转换为迭代器的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo5</span> &#123;<br>    <span class="hljs-keyword">public</span> Demo5 &#123;&#125;<br>    <br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);<br>      <span class="hljs-comment">//获得该集合的迭代器</span><br>      Iterator&lt;Integer&gt; iterator = list.iterator();<br>      <span class="hljs-keyword">while</span>(iterator.hasNext()) &#123;<br>         <span class="hljs-type">Integer</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> iterator.next();<br>         System.out.println(x);<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意<br>foreach 循环写法，能够配合数组，以及所有实现了 Iterable 接口的集合类一起使用，</p>
<p>其中Iterable 用来获取集合的迭代器（ Iterator ）</p>
</blockquote>
<hr>
<h3 id="3-3-6-switch字符串"><a href="#3-3-6-switch字符串" class="headerlink" title="3.3.6 switch字符串"></a>3.3.6 switch字符串</h3><p>从 JDK 7 开始，switch 可以作用于字符串和枚举类，这个功能其实也是语法糖，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo6</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>      <span class="hljs-keyword">switch</span> (str) &#123;<br>         <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;hello&quot;</span> :<br>            System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;world&quot;</span> :<br>            System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意<br>switch 配合 String 和枚举使用时，变量不能为null，原因分析完语法糖转换后的代码应当自然清楚</p>
</blockquote>
<p>会被编译器转换为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo6</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">Demo6</span><span class="hljs-params">()</span> &#123;<br>      <br>   &#125;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>      <span class="hljs-comment">//通过字符串的hashCode+value来判断是否匹配</span><br>      <span class="hljs-keyword">switch</span> (str.hashCode()) &#123;<br>         <span class="hljs-comment">//hello的hashCode</span><br>         <span class="hljs-keyword">case</span> <span class="hljs-number">99162322</span> :<br>            <span class="hljs-comment">//再次比较，因为字符串的hashCode有可能相等</span><br>            <span class="hljs-keyword">if</span>(str.equals(<span class="hljs-string">&quot;hello&quot;</span>)) &#123;<br>               x = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-comment">//world的hashCode</span><br>         <span class="hljs-keyword">case</span> <span class="hljs-number">11331880</span> :<br>            <span class="hljs-keyword">if</span>(str.equals(<span class="hljs-string">&quot;world&quot;</span>)) &#123;<br>               x = <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>      &#125;<br><br>      <span class="hljs-comment">//用第二个switch在进行输出判断</span><br>      <span class="hljs-keyword">switch</span> (x) &#123;<br>         <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>过程说明：</p>
<ul>
<li><p>在编译期间，单个的switch被分为了两个</p>
<ul>
<li><p>第一个用来匹配字符串，并给x赋值</p>
<ul>
<li><p>字符串的匹配用到了字符串的hashCode，还用到了equals方法</p>
</li>
<li><p>使用hashCode是为了提高比较效率，使用equals是防止有hashCode冲突（如BM和C.）</p>
</li>
<li><p>第二个用来根据x的值来决定输出语句</p>
</li>
<li><p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy6_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choose</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (str) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;BM&quot;</span>: &#123;<br>                System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;C.&quot;</span>: &#123;<br>                System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">**会被转换为</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Candy6_2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Candy6_2</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">choose</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-type">byte</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">switch</span>(str.hashCode()) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2123</span>: <span class="hljs-comment">// hashCode 值可能相同，需要进一步用 equals 比较</span><br>        	<span class="hljs-keyword">if</span> (str.equals(<span class="hljs-string">&quot;C.&quot;</span>)) &#123;<br>        		x = <span class="hljs-number">1</span>;<br>        	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (str.equals(<span class="hljs-string">&quot;BM&quot;</span>)) &#123;<br>        		x = <span class="hljs-number">0</span>;<br>        	&#125;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">switch</span>(x) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            	System.out.println(<span class="hljs-string">&quot;h&quot;</span>);<br>            	<span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            	System.out.println(<span class="hljs-string">&quot;w&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-3-7-switch枚举"><a href="#3-3-7-switch枚举" class="headerlink" title="3.3.7 switch枚举"></a>3.3.7 switch枚举</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo7</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">SEX</span> <span class="hljs-variable">sex</span> <span class="hljs-operator">=</span> SEX.MALE;<br>      <span class="hljs-keyword">switch</span> (sex) &#123;<br>         <span class="hljs-keyword">case</span> MALE:<br>            System.out.println(<span class="hljs-string">&quot;man&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">case</span> FEMALE:<br>            System.out.println(<span class="hljs-string">&quot;woman&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>      &#125;<br>   &#125;<br>&#125;<br><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">SEX</span> &#123;<br>   MALE, FEMALE;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>编译器中执行的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo7</span> &#123;<br>   <span class="hljs-comment">/**     </span><br><span class="hljs-comment">    * 定义一个合成类（仅 jvm 使用，对我们不可见）     </span><br><span class="hljs-comment">    * 用来映射枚举的 ordinal 与数组元素的关系     </span><br><span class="hljs-comment">    * 枚举的 ordinal 表示枚举对象的序号，从 0 开始     </span><br><span class="hljs-comment">    * 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1     </span><br><span class="hljs-comment">    */</span> <br>   <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">$MAP</span> &#123;<br>      <span class="hljs-comment">//数组大小即为枚举元素个数，里面存放了case用于比较的数字</span><br>      <span class="hljs-keyword">static</span> <span class="hljs-type">int</span>[] map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>];<br>      <span class="hljs-keyword">static</span> &#123;<br>         <span class="hljs-comment">//ordinal即枚举元素对应所在的位置，MALE为0，FEMALE为1</span><br>         map[SEX.MALE.ordinal()] = <span class="hljs-number">1</span>;<br>         map[SEX.FEMALE.ordinal()] = <span class="hljs-number">2</span>;<br>      &#125;<br>   &#125;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">SEX</span> <span class="hljs-variable">sex</span> <span class="hljs-operator">=</span> SEX.MALE;<br>      <span class="hljs-comment">//将对应位置枚举元素的值赋给x，用于case操作</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> $MAP.map[sex.ordinal()];<br>      <span class="hljs-keyword">switch</span> (x) &#123;<br>         <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            System.out.println(<span class="hljs-string">&quot;man&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            System.out.println(<span class="hljs-string">&quot;woman&quot;</span>);<br>            <span class="hljs-keyword">break</span>;<br>         <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>      &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-3-8-枚举类"><a href="#3-3-8-枚举类" class="headerlink" title="3.3.8 枚举类"></a>3.3.8 枚举类</h3><p>JDK 7 新增了枚举类，以前面的性别枚举为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">SEX</span> &#123;<br>   MALE, FEMALE;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>转换后的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Sex</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Enum</span>&lt;<span class="hljs-title">Sex</span>&gt; </span>&#123;   <br>   <span class="hljs-comment">//对应枚举类中的元素</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">final</span> Sex MALE;    <br>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">final</span> Sex FEMALE;    <br>   <span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">final</span> Sex[] <span class="hljs-variable">$VALUES</span>;<br>   <br>    <span class="hljs-built_in">static</span> &#123;       <br>    	<span class="hljs-comment">//调用构造函数，传入枚举元素的值及ordinal</span><br>    	MALE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sex</span>(<span class="hljs-string">&quot;MALE&quot;</span>, <span class="hljs-number">0</span>);    <br>        FEMALE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sex</span>(<span class="hljs-string">&quot;FEMALE&quot;</span>, <span class="hljs-number">1</span>);   <br>        <span class="hljs-variable">$VALUES</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sex</span>[]&#123;MALE, FEMALE&#125;; <br>   &#125;<br> 	<br>   <span class="hljs-comment">//调用父类中的方法</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">Sex</span>(String name, <span class="hljs-keyword">int</span> ordinal) &#123;     <br>        <span class="hljs-title function_ invoke__">super</span>(name, ordinal);    <br>    &#125;<br>   <br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Sex[] <span class="hljs-title function_ invoke__">values</span>() &#123;  <br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$VALUES</span>.<span class="hljs-keyword">clone</span>();  <br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> Sex <span class="hljs-title function_ invoke__">valueOf</span>(String name) &#123; <br>        <span class="hljs-keyword">return</span> Enum.<span class="hljs-title function_ invoke__">valueOf</span>(Sex.<span class="hljs-keyword">class</span>, name);  <br>    &#125; <br>   <br>&#125;Copy<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-3-9-try-with-resources"><a href="#3-3-9-try-with-resources" class="headerlink" title="3.3.9 try-with-resources"></a>3.3.9 try-with-resources</h3><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yE411Z7AP?p=140">https://www.bilibili.com/video/BV1yE411Z7AP?p=140</a></p>
<hr>
<h3 id="3-3-10-方法重写时的桥接方法"><a href="#3-3-10-方法重写时的桥接方法" class="headerlink" title="3.3.10 方法重写时的桥接方法"></a>3.3.10 方法重写时的桥接方法</h3><p>我们都知道，方法重写时对返回值分两种情况：</p>
<ul>
<li>父子类的返回值完全一致</li>
<li>子类返回值可以是父类返回值的子类（比较绕口，见下面的例子）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">public</span> Number <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>    	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">// 子类 m 方法的返回值是 Integer 是父类 m 方法返回值 Number 的子类</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>    	<span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>对于子类，java 编译器会做如下处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>    	<span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-comment">// 此方法才是真正重写了父类 public Number m() 方法</span><br>    <span class="hljs-keyword">public</span> synthetic bridge Number <span class="hljs-title function_">m</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 调用 public Integer m()</span><br>        <span class="hljs-keyword">return</span> m();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中桥接方法比较特殊，仅对 java 虚拟机可见，并且与原来的 public Integer m() 没有命名冲突，可以<br>用下面反射代码来验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (Method m : B.class.getDeclaredMethods()) &#123;<br>	System.out.println(m);<br>&#125;<br><br><span class="hljs-comment">//会输出</span><br><span class="hljs-keyword">public</span> java.lang.Integer test.candy.B.m()<br><span class="hljs-keyword">public</span> java.lang.Number test.candy.B.m()<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-3-11-匿名内部类"><a href="#3-3-11-匿名内部类" class="headerlink" title="3.3.11 匿名内部类"></a>3.3.11 匿名内部类</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo8</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>      <span class="hljs-title class_">Runnable</span> runnable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;running...&quot;</span>);<br>         &#125;<br>      &#125;;<br>   &#125;<br>&#125;<span class="hljs-title class_">Copy</span><br></code></pre></td></tr></table></figure>

<p>转换后的代码</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo8</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) &#123;<br>      <span class="hljs-comment">//用额外创建的类来创建匿名内部类对象</span><br>      <span class="hljs-title class_">Runnable</span> runnable = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo8</span><span class="hljs-title function_">$1</span>();<br>   &#125;<br>&#125;<br><br><span class="hljs-comment">//创建了一个额外的类，实现了Runnable接口</span><br>final <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo8$1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-title class_">Demo8</span><span class="hljs-title function_">$1</span>() &#123;&#125;<br><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">&quot;running...&quot;</span>);<br>   &#125;<br>&#125;<span class="hljs-title class_">Copy</span><br></code></pre></td></tr></table></figure>

<p>如果匿名内部类中引用了<strong>局部变量</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo8</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>      <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(x);<br>         &#125;<br>      &#125;;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>转化后代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo8</span> &#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>      <span class="hljs-type">Runnable</span> <span class="hljs-variable">runnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>         <span class="hljs-meta">@Override</span><br>         <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(x);<br>         &#125;<br>      &#125;;<br>   &#125;<br>&#125;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo8$1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>   <span class="hljs-comment">//多创建了一个变量</span><br>   <span class="hljs-type">int</span> val$x;<br>   <span class="hljs-comment">//变为了有参构造器</span><br>   <span class="hljs-keyword">public</span> Demo8$<span class="hljs-number">1</span>(<span class="hljs-type">int</span> x) &#123;<br>      <span class="hljs-built_in">this</span>.val$x = x;<br>   &#125;<br><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>      System.out.println(val$x);<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3-4-类加载阶段-重要"><a href="#3-4-类加载阶段-重要" class="headerlink" title="3.4 类加载阶段(重要)"></a>3.4 类加载阶段(重要)</h2><h3 id="3-4-1-加载"><a href="#3-4-1-加载" class="headerlink" title="3.4.1 加载"></a>3.4.1 加载</h3><ul>
<li><p>将类的字节码载入</p>
<p>方法区</p>
<p>（1.8后为元空间，在本地内存中）中，内部采用 C++ 的 instanceKlass 描述 java 类，它的重要 ﬁeld 有：</p>
<ul>
<li>_java_mirror 即 java 的类镜像，例如对 String 来说，它的镜像类就是 String.class，作用是把 klass 暴露给 java 使用</li>
<li>_super 即父类</li>
<li>_ﬁelds 即成员变量</li>
<li>_methods 即方法</li>
<li>_constants 即常量池</li>
<li>_class_loader 即类加载器</li>
<li>_vtable 虚方法表</li>
<li>_itable 接口方法</li>
</ul>
</li>
<li><p>如果这个类还有父类没有加载，<strong>先加载父类</strong></p>
</li>
<li><p>加载和链接可能是<strong>交替运行</strong>的</p>
</li>
</ul>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220810223332427.png" srcset="/img/loading.gif" lazyload alt="image-20220810223332427"></p>
<blockquote>
<ul>
<li>instanceKlass 这样的【元数据】是存储在方法区（1.8 后的元空间内，而元空间又位于本地内存中），但 _java_mirror<br>是存储在堆中<ul>
<li>InstanceKlass和*.class(JAVA镜像类 _java_mirror)互相保存了对方的地址</li>
<li>类的对象在对象头中保存了*.class的地址。让对象可以通过其找到方法区中的instanceKlass，从而获取类的各种信息</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<h3 id="3-4-2-链接"><a href="#3-4-2-链接" class="headerlink" title="3.4.2 链接"></a>3.4.2 链接</h3><h4 id="3-4-2-1-验证"><a href="#3-4-2-1-验证" class="headerlink" title="3.4.2.1 验证"></a>3.4.2.1 验证</h4><p>验证类是否符合 JVM规范，安全性检查</p>
<p>例如：</p>
<p>用 UE 等支持二进制的编辑器修改 HelloWorld.class 的魔数（3.1.1），在控制台运行</p>
<p><img src="https://gitee.com/Gu-taicheng/image/raw/master/img/image-20220810230057883.png" srcset="/img/loading.gif" lazyload alt="image-20220810230057883"></p>
<hr>
<h4 id="3-4-2-2-准备"><a href="#3-4-2-2-准备" class="headerlink" title="3.4.2.2 准备"></a>3.4.2.2 准备</h4><p>为 static 变量分配空间，设置默认值</p>
<ul>
<li><p>static变量在JDK 7以前是存储与instanceKlass末尾。但在JDK 7以后就存储在_java_mirror末尾了（即堆中）</p>
</li>
<li><p>static变量在分配空间和赋值是在两个阶段完成的。分配空间在准备阶段完成，赋值在初始化阶段完成</p>
<ul>
<li><p>如果 static 变量是 ﬁnal 的<strong>基本类型</strong>，以及<strong>字符串常量</strong>，那么<strong>编译</strong>阶段值就确定了，<strong>赋值在准备阶段完成</strong></p>
</li>
<li><p>如果 static 变量是 ﬁnal 的，但属于<strong>引用类型</strong>（比如 new Object()），那么赋值也会在<strong>初始化阶段完成</strong></p>
</li>
</ul>
</li>
</ul>
<hr>
<h4 id="3-4-2-3-解析"><a href="#3-4-2-3-解析" class="headerlink" title="3.4.2.3 解析"></a>3.4.2.3 解析</h4><ul>
<li>将常量池中的<strong>符号引用解析为直接引用</strong><ul>
<li>符号引用：仅仅是个符号，不知道这个类或者方法、属性具体在内存的哪个位置</li>
<li>直接引用：知道这个类或者方法、属性具体在内存的哪个位置</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 解析的含义</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException,IOException &#123;<br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classloader</span> <span class="hljs-operator">=</span> Load2.class.getClassLoader();<br>        <span class="hljs-comment">// loadClass 方法不会导致类的解析和初始化</span><br>        Class&lt;?&gt; c = classloader.loadClass(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.C&quot;</span>);<br>        <span class="hljs-comment">// new C(); new会导致类的解析和初始化</span><br>        System.in.read();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> &#123;<br>	<span class="hljs-type">D</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">D</span>();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> &#123;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-4-3-初始化"><a href="#3-4-3-初始化" class="headerlink" title="3.4.3 初始化"></a>3.4.3 初始化</h3><p>初始化即调用 <clinit>()V ，虚拟机会保证这个类的『构造方法』的线程安全</p>
<ul>
<li>clinit()方法是由编译器自动收集类中的所有类变量的<strong>赋值动作和静态语句块</strong>（static{}块）中的语句合并产生的<ul>
<li>所以<strong>验证类是否被初始化，可以看该类的静态代码块是否被执行</strong></li>
</ul>
</li>
</ul>
<h4 id="3-4-3-1-发生时机"><a href="#3-4-3-1-发生时机" class="headerlink" title="3.4.3.1 发生时机"></a>3.4.3.1 发生时机</h4><p><strong>类的初始化的懒惰的</strong>，以下情况会初始化</p>
<ul>
<li>main 方法所在的类，总会被首先初始化</li>
<li>首次访问这个类的静态变量或静态方法时</li>
<li>子类初始化，如果父类还没初始化，会引发</li>
<li>子类访问父类的静态变量，只会触发父类的初始化</li>
<li>Class.forName</li>
<li>new 会导致初始化</li>
</ul>
<p>以下情况不会初始化</p>
<ul>
<li>访问类的 static ﬁnal 静态常量（基本类型和字符串）</li>
<li>类对象.class 不会触发初始化</li>
<li>创建该类对象的数组</li>
<li>类加载器的.loadClass方法</li>
<li>Class.forNamed的参数2为false时</li>
</ul>
<p><strong>如下代码验证</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load3</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main init&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, IOException &#123;<br><span class="hljs-comment">//        // 1. 静态常量不会触发初始化</span><br><span class="hljs-comment">//        System.out.println(B.b);</span><br><span class="hljs-comment">//        // 2. 类对象.class 不会触发初始化</span><br><span class="hljs-comment">//        System.out.println(B.class);</span><br><span class="hljs-comment">//        // 3. 创建该类的数组不会触发初始化</span><br><span class="hljs-comment">//        System.out.println(new B[0]);</span><br>        <span class="hljs-comment">// 4. 不会初始化类 B，但会加载 B、A</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br>        cl.loadClass(<span class="hljs-string">&quot;cn.itcast.jvm.t3.load.B&quot;</span>);<br><span class="hljs-comment">//        // 5. 不会初始化类 B，但会加载 B、A</span><br><span class="hljs-comment">//        ClassLoader c2 = Thread.currentThread().getContextClassLoader();</span><br><span class="hljs-comment">//        Class.forName(&quot;cn.itcast.jvm.t3.load.B&quot;, false, c2);</span><br>        System.in.read();<br><br><br><span class="hljs-comment">//        // 1. 首次访问这个类的静态变量或静态方法时</span><br><span class="hljs-comment">//        System.out.println(A.a);</span><br><span class="hljs-comment">//        // 2. 子类初始化，如果父类还没初始化，会引发</span><br><span class="hljs-comment">//        System.out.println(B.c);</span><br><span class="hljs-comment">//        // 3. 子类访问父类静态变量，只触发父类初始化</span><br><span class="hljs-comment">//        System.out.println(B.a);</span><br><span class="hljs-comment">//        // 4. 会初始化类 B，并先初始化类 A</span><br><span class="hljs-comment">//        Class.forName(&quot;cn.itcast.jvm.t3.load.B&quot;);</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a init&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">A</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">5.0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;b init&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<hr>
<h3 id="3-4-4-练习"><a href="#3-4-4-练习" class="headerlink" title="3.4.4 练习"></a>3.4.4 练习</h3><h4 id="3-4-4-1-练习一"><a href="#3-4-4-1-练习一" class="headerlink" title="3.4.4.1 练习一"></a>3.4.4.1 练习一</h4><p>从字节码分析，使用 a，b，c 这三个常量是否会导致 E 初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(E.a);<br>        System.out.println(E.b);<br>        System.out.println(E.c);<br><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">E</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;  <span class="hljs-comment">// Integer.valueOf(20)</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;init E&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>答案：a，b不会，c会<br>因为a和b都属于类的 static ﬁnal 静态常量（基本类型和字符串）<br>c的Integer是包装类型 会用语法糖执行Integer.valueOf(20) 把 20 这个基本类型转换成Integer</p>
</blockquote>
<hr>
<h4 id="3-4-4-2-练习二"><a href="#3-4-4-2-练习二" class="headerlink" title="3.4.4.2 练习二"></a>3.4.4.2 练习二</h4><p>完成懒惰初始化单例模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.jvm.t3.load;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Load9</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br><span class="hljs-comment">//        Singleton.test();</span><br>        Singleton.getInstance();<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;test&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//构造方法私有</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;&#125;<br><br>    <span class="hljs-comment">//静态内部类中保存单例，静态内部类的好处就是可以访问外部类的资源，比如构造方法和方法（私有的也可访问）</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyHolder</span>&#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">SINGLETON</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>        <span class="hljs-keyword">static</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;lazy holder init&quot;</span>);<span class="hljs-comment">//用于验证是否初始化</span><br>        &#125;<br>    &#125;<br>    <br>	<span class="hljs-comment">// 第一次调用 getInstance 方法，才会导致内部类加载和初始化其静态成员</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LazyHolder.SINGLETON;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>静态内部类中保存单例，静态内部类的好处就是可以访问外部类的资源，比如构造方法和方法（私有的也可访问）</strong></p>
<p>以上的实现特点是：</p>
<ul>
<li>懒惰实例化</li>
<li>初始化时的线程安全是有保障的</li>
<li>完美(哈哈哈哈哈)</li>
</ul>
<hr>
<h2 id="3-5-类加载器"><a href="#3-5-类加载器" class="headerlink" title="3.5 类加载器"></a>3.5 类加载器</h2><h3 id="3-5-1-类与类加载器"><a href="#3-5-1-类与类加载器" class="headerlink" title="3.5.1 类与类加载器"></a>3.5.1 类与类加载器</h3><p>类加载器虽然只用于实现类的加载动作，但它在Java程序中起到的作用却远超类加载阶段</p>
<p>对于任意一个类，都必须由加载它的<strong>类加载器</strong>和这个<strong>类本身</strong>一起共同确立其在Java虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。这句话可以表达得更通俗一些：<strong>比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义</strong>，否则，即使这两个类来源于同一个Class文件，被同一个Java虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等</p>
<p>以JDK 8为例</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>加载的类</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Bootstrap ClassLoader（启动类加载器）</td>
<td>JAVA_HOME&#x2F;jre&#x2F;lib</td>
<td>无法直接访问</td>
</tr>
<tr>
<td>Extension ClassLoader(拓展类加载器)</td>
<td>JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext</td>
<td>上级为Bootstrap，<strong>显示为null</strong></td>
</tr>
<tr>
<td>Application ClassLoader(应用程序类加载器)</td>
<td>classpath</td>
<td>上级为Extension</td>
</tr>
<tr>
<td>自定义类加载器</td>
<td>自定义</td>
<td>上级为Application</td>
</tr>
</tbody></table>
<ul>
<li><p>各司其职，每个加载器只加载自己负责目录下的所有的类</p>
</li>
<li><p>层级关系：</p>
<ul>
<li><p>自底向上询问有没有加载过，例如String类</p>
<ul>
<li>自定义类加载器 问 应用程序类加载器有没有加载String，如果没有，继续往上，到达启动类加载器中已经加载过了，则String不用再加载</li>
</ul>
</li>
<li><p>如果都没有加载过则由最顶级开始往下，查找自己负责的目录下能不能加载；例如自定义的Student类</p>
<ul>
<li>先往上询问，肯定都没有加载过，然后再一步步下来到应用程序加载器</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="3-5-2-启动类加载器"><a href="#3-5-2-启动类加载器" class="headerlink" title="3.5.2 启动类加载器"></a>3.5.2 启动类加载器</h3><p>可通过在控制台输入指令，使得自定义类被启动类加器加载</p>
<p>在正确的路径下执行：java -Xbootclasspath&#x2F;a:.cn.itcast.jvm.t3.load.Load5</p>
<h3 id="3-5-3-扩展类加载类"><a href="#3-5-3-扩展类加载类" class="headerlink" title="3.5.3 扩展类加载类"></a>3.5.3 扩展类加载类</h3><p>如果<strong>classpath</strong>和 <strong>JAVA_HOME&#x2F;jre&#x2F;lib&#x2F;ext</strong> 下有同名类，加载时会使用<strong>拓展类加载器</strong>加载。当应用程序类加载器发现拓展类加载器已将该同名类加载过了，则不会再次加载</p>
<h3 id="3-5-4-双亲委派模式"><a href="#3-5-4-双亲委派模式" class="headerlink" title="3.5.4 双亲委派模式"></a>3.5.4 双亲委派模式</h3><p>所谓的双亲委派，就是指调用类加载器的 loadClass 方法时，查找类的规则</p>
<blockquote>
<p><strong>注意</strong><br>这里的双亲，翻译为上级似乎更为合适，因为它们并没有继承关系</p>
</blockquote>
<p>loadClass源码</p>
<p>递归查找</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-keyword">synchronized</span> (getClassLoadingLock(name)) &#123;<br>        <span class="hljs-comment">// 首先查找该类是否已经被该类加载器加载过了</span><br>        Class&lt;?&gt; c = findLoadedClass(name);<br>        <span class="hljs-comment">//如果没有被加载过</span><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">t0</span> <span class="hljs-operator">=</span> System.nanoTime();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//看是否被它的上级加载器加载过了 Extension的上级是Bootstarp，但它显示为null</span><br>                <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">//有上级，就委派上级 这里是递归</span><br>                    c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">//如果没有上级了（ExtClassLoader），则委派BootstrapClassLoader 看是否被启动类加载器加载过</span><br>                    c = findBootstrapClassOrNull(name);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>                <span class="hljs-comment">// from the non-null parent class loader</span><br>                <span class="hljs-comment">//捕获异常，但不做任何处理</span><br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//如果还是没有找到，先让拓展类加载器调用findClass方法去找到该类，如果还是没找到，就抛出异常</span><br>                <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.nanoTime();<br>                c = findClass(name);<br><br>                <span class="hljs-comment">// 记录时间</span><br>                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);<br>                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);<br>                sun.misc.PerfCounter.getFindClasses().increment();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (resolve) &#123;<br>            resolveClass(c);<br>        &#125;<br>        <span class="hljs-keyword">return</span> c;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为了防止内存中出现多个相同的字节码；因为如果没有双亲委派的话，用户就可以自己定义一个java.lang.String类，那么就无法保证类的唯一性。</p>
<hr>
<h3 id="3-5-5-自定义加载器"><a href="#3-5-5-自定义加载器" class="headerlink" title="3.5.5 自定义加载器"></a>3.5.5 自定义加载器</h3><h4 id="3-5-5-1-使用场景"><a href="#3-5-5-1-使用场景" class="headerlink" title="3.5.5.1 使用场景"></a>3.5.5.1 使用场景</h4><ul>
<li>想加载非 classpath 随意路径中的类文件</li>
<li>通过接口来使用实现，希望解耦时，常用在框架设计</li>
<li>这些类希望予以隔离，不同应用的同名类都可以加载，不冲突，常见于 tomcat 容器</li>
</ul>
<h4 id="3-5-5-2-步骤"><a href="#3-5-5-2-步骤" class="headerlink" title="3.5.5.2 步骤"></a>3.5.5.2 步骤</h4><ul>
<li>继承ClassLoader父类</li>
<li>要遵从双亲委派机制，重写 ﬁndClass 方法<ul>
<li>不是重写loadClass方法，否则不会走双亲委派机制</li>
</ul>
</li>
<li>读取类文件的字节码</li>
<li>调用父类的 deﬁneClass 方法来加载类</li>
<li>使用者调用该类加载器的 loadClass 方法</li>
</ul>
<hr>
<h2 id="3-6-破坏双亲委派"><a href="#3-6-破坏双亲委派" class="headerlink" title="3.6 破坏双亲委派"></a>3.6 破坏双亲委派</h2><p><strong>那怎么打破双亲委派模型</strong>？</p>
<p>自定义类加载器，继承ClassLoader类，重写loadClass方法和findClass方法。</p>
<p><strong>列举一些你知道的打破双亲委派机制的例子，为什么要打破？</strong></p>
<ul>
<li><p>JNDI 通过引入线程上下文类加载器，可以在 Thread.setContextClassLoader 方法设置，默认是应用程序类加载器，来加载 SPI 的代码。有了线程上下文类加载器，就可以完成父类加载器请求子类加载器完成类加载的行为。打破的原因，是为了 JNDI 服务的类加载器是启动器类加载，为了完成高级类加载器请求子类加载器（即上文中的线程上下文加载器）加载类。</p>
</li>
<li><p>Tomcat，应用的类加载器优先自行加载应用目录下的 class，并不是先委派给父加载器，加载不了才委派给父加载器。</p>
<p>tomcat之所以造了一堆自己的classloader，大致是出于下面三类目的：</p>
<ul>
<li>对于各个 <code>webapp</code>中的 <code>class</code>和 <code>lib</code>，需要相互隔离，不能出现一个应用中加载的类库会影响另一个应用的情况，而对于许多应用，需要有共享的lib以便不浪费资源。</li>
<li>与 <code>jvm</code>一样的安全性问题。使用单独的 <code>classloader</code>去装载 <code>tomcat</code>自身的类库，以免其他恶意或无意的破坏；</li>
<li>热部署。</li>
</ul>
<p>tomcat类加载器如下图：</p>
<p><img src="http://blog-img.coolsen.cn/img/image-20210329231930719.png" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>OSGi，实现模块化热部署，为每个模块都自定义了类加载器，需要更换模块时，模块与类加载器一起更换。其类加载的过程中，有平级的类加载器加载行为。打破的原因是为了实现模块热替换。</p>
</li>
<li><p>JDK 9，Extension ClassLoader 被 Platform ClassLoader 取代，当平台及应用程序类加载器收到类加载请求，在委派给父加载器加载前，要先判断该类是否能够归属到某一个系统模块中，如果可以找到这样的归属关系，就要优先委派给负责那个模块的加载器完成加载。打破的原因，是为了添加模块化的特性。</p>
</li>
</ul>
<hr>
<h2 id="3-7-运行期优化"><a href="#3-7-运行期优化" class="headerlink" title="3.7 运行期优化"></a>3.7 运行期优化</h2><h3 id="3-7-1-即时编译"><a href="#3-7-1-即时编译" class="headerlink" title="3.7.1 即时编译"></a>3.7.1 即时编译</h3><h4 id="3-7-1-1分层编译"><a href="#3-7-1-1分层编译" class="headerlink" title="3.7.1.1分层编译"></a>3.7.1.1分层编译</h4><p>JVM 将执行状态分成了 5 个层次：</p>
<ul>
<li>0层：解释执行，用解释器将字节码翻译为机器码</li>
<li>1层：使用 <strong>C1 即时编译器</strong>编译执行（不带 proﬁling）</li>
<li>2层：使用 C1 即时编译器编译执行（带基本的profiling）</li>
<li>3层：使用 C1 即时编译器编译执行（带完全的profiling）</li>
<li>4层：使用 <strong>C2 即时编译器</strong>编译执行</li>
</ul>
<blockquote>
<p>proﬁling 是指在运行过程中收集一些程序执行状态的数据，例如【方法的调用次数】，【循环的 回边次数】等</p>
</blockquote>
<h5 id="即时编译器（JIT）与解释器的区别"><a href="#即时编译器（JIT）与解释器的区别" class="headerlink" title="即时编译器（JIT）与解释器的区别"></a>即时编译器（JIT）与解释器的区别</h5><ul>
<li>解释器<ul>
<li>将字节码<strong>解释</strong>为机器码，下次即使遇到相同的字节码，仍会执行重复的解释</li>
<li>是将字节码解释为针对所有平台都通用的机器码</li>
</ul>
</li>
<li>即时编译器<ul>
<li>将一些字节码<strong>编译</strong>为机器码，<strong>并存入 Code Cache</strong>，下次遇到相同的代码，直接执行，无需再编译</li>
<li>根据平台类型，生成平台特定的机器码</li>
</ul>
</li>
</ul>
<p>对于大部分的不常用的代码，我们无需耗费时间将其<strong>编译</strong>成机器码，而是采取解释执行的方式运行；另一方面，对于仅占据小部分的热点代码，我们则可以将其编译成机器码，以达到理想的运行速度。 执行效率上简单比较一下 Interpreter &lt; C1 &lt; C2，总的目标是发现热点代码（hotspot名称的由 来），并优化这些热点代码（例如循环1000次  new Obkect对象，一定次数之后，就会把new Object()编译成机器码，提高效率）</p>
<h5 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h5><p>逃逸分析（Escape Analysis）简单来讲就是，Java Hotspot 虚拟机可以分析新创建对象的使用范围，并决定是否在 Java 堆上分配内存的一项技术（例如上述，1000个Object对象循环创建，但是从来没用过，就会在一段时间后发生逃逸，修改字节码，后续使它实际上没有被创建）</p>
<p>逃逸分析的 JVM 参数如下：</p>
<ul>
<li>开启逃逸分析：-XX:+DoEscapeAnalysis</li>
<li>关闭逃逸分析：-XX:-DoEscapeAnalysis</li>
<li>显示分析结果：-XX:+PrintEscapeAnalysis</li>
</ul>
<p>逃逸分析技术在 Java SE 6u23+ 开始支持，并默认设置为启用状态，可以不用额外加这个参数</p>
<hr>
<h3 id="3-7-2-方法内联"><a href="#3-7-2-方法内联" class="headerlink" title="3.7.2 方法内联"></a>3.7.2 方法内联</h3><h4 id="3-7-2-1-内联函数"><a href="#3-7-2-1-内联函数" class="headerlink" title="3.7.2.1 内联函数"></a>3.7.2.1 内联函数</h4><p>内联函数就是在程序编译时，编译器将程序中出现的内联函数的调用表达式用内联函数的函数体来直接进行替换</p>
<p>C++是否为内联函数由自己决定，<strong>Java由编译器决定</strong>。Java不支持直接声明为内联函数的，如果想让他内联，你只能够向编译器提出请求: 关键字<strong>final修饰</strong> 用来指明那个函数是希望被JVM内联的，如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> &#123;  <br>        <span class="hljs-comment">// to do something  </span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>总的来说，一般的函数都不会被当做内联函数，只有声明了final后，编译器才会考虑是不是要把你的函数变成内联函数</p>
<p>JVM内建有许多运行时优化。首先<strong>短方法</strong>更利于JVM推断。流程更明显，作用域更短，副作用也更明显。如果是长方法JVM可能直接就跪了。</p>
<hr>
<h4 id="3-7-2-1-举例"><a href="#3-7-2-1-举例" class="headerlink" title="3.7.2.1 举例"></a>3.7.2.1 举例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">square</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> i)</span> &#123;<br>	<span class="hljs-keyword">return</span> i * i;<br>&#125;<br><br>System.out.println(square(<span class="hljs-number">9</span>));<br></code></pre></td></tr></table></figure>



<p>如果发现 square 是热点方法，并且长度不太长时，会进行内联，所谓的内联就是把方法内代码拷贝、<br>粘贴到调用者的位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(<span class="hljs-number">9</span> * <span class="hljs-number">9</span>);<br></code></pre></td></tr></table></figure>



<p>还能够进行常量折叠（constant folding）的优化(因为计算结果始终都是81，就当成一个常量看)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">System.out.println(<span class="hljs-number">81</span>);<br></code></pre></td></tr></table></figure>



<hr>
<h1 id="4-内存模型"><a href="#4-内存模型" class="headerlink" title="4. 内存模型"></a>4. 内存模型</h1><p>听说这部分结合juc并发学习更好，学成后更新^_^</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Java/" class="category-chain-item">Java</a>
  
  
    <span>></span>
    
  <a href="/categories/Java/JVM/" class="category-chain-item">JVM</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Java/">#Java</a>
      
        <a href="/tags/JVM/">#JVM</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>jvm学习</div>
      <div>https://blog.gutaicheng.top/2022/08/06/JVM学习/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>GuTaicheng</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年8月6日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/11/%E5%A4%B1%E7%9C%A0%E5%90%8E%E7%9A%84%E7%84%A6%E8%99%91/" title="失眠后的焦虑">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">失眠后的焦虑</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/25/%E6%8F%92%E5%85%A5%E6%8E%92%E5%BA%8F/" title="插入排序">
                        <span class="hidden-mobile">插入排序</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"Mm7zXkSdUNoJGtCjXx5EokSc-gzGzoHsz","appKey":"QeD6ibBU3GKctfSty5fFG9Xz","path":"window.location.pathname","placeholder":"什么都不用填就可以评论啦(当然留个qq或者邮箱更好哦)","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
